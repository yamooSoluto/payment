# êµ¬ë… ê²°ì œ ì‹œìŠ¤í…œ ì¼€ì´ìŠ¤ ì •ë¦¬

êµ¬ë… ê²°ì œ ì‹œìŠ¤í…œ êµ¬í˜„ ì‹œ ê³ ë ¤í•´ì•¼ í•  ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ì™€ ì—£ì§€ ì¼€ì´ìŠ¤ë¥¼ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

## ëª©ì°¨
1. [ê¸°ë³¸ êµ¬ë… ì‹œë‚˜ë¦¬ì˜¤](#1-ê¸°ë³¸-êµ¬ë…-ì‹œë‚˜ë¦¬ì˜¤)
2. [í”Œëœ ë³€ê²½ ì‹œë‚˜ë¦¬ì˜¤](#2-í”Œëœ-ë³€ê²½-ì‹œë‚˜ë¦¬ì˜¤)
3. [êµ¬ë… í•´ì§€ ì‹œë‚˜ë¦¬ì˜¤](#3-êµ¬ë…-í•´ì§€-ì‹œë‚˜ë¦¬ì˜¤)
4. [ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬](#4-ê²°ì œ-ì‹¤íŒ¨-ì²˜ë¦¬)
5. [ì—£ì§€ ì¼€ì´ìŠ¤](#5-ì—£ì§€-ì¼€ì´ìŠ¤)
6. [ë§¤ì¥ ì‚­ì œ / íšŒì› íƒˆí‡´](#6-ë§¤ì¥-ì‚­ì œ--íšŒì›-íƒˆí‡´)
7. [í˜„ì¬ êµ¬í˜„ ìƒíƒœ](#7-í˜„ì¬-êµ¬í˜„-ìƒíƒœ)
8. [Vercel Cron Job ìƒì„¸](#8-vercel-cron-job-ìƒì„¸)
9. [Firestore ì»¬ë ‰ì…˜ êµ¬ì¡°](#9-firestore-ì»¬ë ‰ì…˜-êµ¬ì¡°)
10. [ì•Œë¦¼ ì´ë ¥ ê´€ë¦¬ ì‹œìŠ¤í…œ (TODO)](#10-ì•Œë¦¼-ì´ë ¥-ê´€ë¦¬-ì‹œìŠ¤í…œ-todo)
11. [ì°¸ê³  ìë£Œ](#11-ì°¸ê³ -ìë£Œ)
12. [ë‹¤ìŒ êµ¬í˜„ ìš°ì„ ìˆœìœ„](#12-ë‹¤ìŒ-êµ¬í˜„-ìš°ì„ ìˆœìœ„)

---

## 1. ê¸°ë³¸ êµ¬ë… ì‹œë‚˜ë¦¬ì˜¤

### 1.1 ë¬´ë£Œ ì²´í—˜ ì‹œì‘
- **ì¼€ì´ìŠ¤**: ì‹ ê·œ ì‚¬ìš©ìê°€ ë¬´ë£Œ ì²´í—˜ ì‹ ì²­
- **ì²˜ë¦¬**:
  - ì¹´ë“œ ì •ë³´ ë“±ë¡ **ì—†ì´** ì²´í—˜ ì‹œì‘
  - ì²´í—˜ ê¸°ê°„ ì„¤ì • (ì˜ˆ: 1ë‹¬)
  - êµ¬ë… ìƒíƒœ: `trial`
  - ì²´í—˜ ì¢…ë£Œì¼ ì €ì¥
  - ë¹Œë§í‚¤ëŠ” ë‚˜ì¤‘ì— ìœ ë£Œ ì „í™˜ ì‹œì ì— ë“±ë¡
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 1.2 ë¬´ë£Œ ì²´í—˜ â†’ ìœ ë£Œ ì „í™˜ (ì‚¬ìš©ì ì„ íƒ)
- **ì¼€ì´ìŠ¤**: ì‚¬ìš©ìê°€ ì²´í—˜ ì¤‘ ìœ ë£Œ ì „í™˜ ê²°ì •
- **ì²˜ë¦¬ (ì¦‰ì‹œ ì „í™˜)**:
  - ì¹´ë“œ ì •ë³´ ì…ë ¥ â†’ ë¹Œë§í‚¤ ë°œê¸‰
  - ì„ íƒí•œ í”Œëœìœ¼ë¡œ ì¦‰ì‹œ ê²°ì œ
  - êµ¬ë… ìƒíƒœ: `trial` â†’ `active`
  - `currentPeriodStart` = ì˜¤ëŠ˜
- **ì²˜ë¦¬ (ì˜ˆì•½ ì „í™˜)**:
  - ì¹´ë“œ ì •ë³´ ì…ë ¥ â†’ ë¹Œë§í‚¤ ë°œê¸‰
  - `pendingPlan`, `pendingAmount` ì €ì¥
  - ì²´í—˜ ì¢…ë£Œì¼ì— ìë™ ê²°ì œ + êµ¬ë… í™œì„±í™”
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 1.3 ë¬´ë£Œ ì²´í—˜ ê¸°ê°„ ë§Œë£Œ
- **ì¼€ì´ìŠ¤**: ì‚¬ìš©ìê°€ ìœ ë£Œ ì „í™˜í•˜ì§€ ì•Šê³  ì²´í—˜ ê¸°ê°„ ì¢…ë£Œ
- **ì²˜ë¦¬**:
  - ë¹Œë§í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ ìë™ ì „í™˜ ë¶ˆê°€
  - êµ¬ë… ìƒíƒœ: `trial` â†’ `expired`
  - ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ë‹¨
  - ë°ì´í„°ëŠ” 90ì¼ê°„ ë³´ê´€
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

#### 1.3.1 ë¬´ë£Œ ì²´í—˜ ì¤‘ ì˜ˆì•½ í›„ ì·¨ì†Œ
- **ì¼€ì´ìŠ¤**: í”Œëœ ì˜ˆì•½í–ˆë‹¤ê°€ ì·¨ì†Œ í›„ ì²´í—˜ ê¸°ê°„ ë§Œë£Œ
- **ì²˜ë¦¬**:
  - ë¹Œë§í‚¤ëŠ” ë“±ë¡ë˜ì–´ ìˆìŒ (ì˜ˆì•½ ì‹œ ë“±ë¡ë¨)
  - `pendingPlan` = null (ì·¨ì†Œë¡œ ì¸í•´ ì‚­ì œë¨)
  - ì²´í—˜ ì¢…ë£Œ ì‹œ `pendingPlan`ì´ ì—†ìœ¼ë¯€ë¡œ ìë™ ê²°ì œ ì‹œë„ ì•ˆ í•¨
  - êµ¬ë… ìƒíƒœ: `trial` â†’ `expired`
  - ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ë‹¨
  - ë°ì´í„°ëŠ” 90ì¼ê°„ ë³´ê´€
  - ë“±ë¡ëœ ë¹Œë§í‚¤ëŠ” ìœ ì§€ë˜ì–´ ë‚˜ì¤‘ì— ì¬êµ¬ë… ì‹œ ì¬ì‚¬ìš© ê°€ëŠ¥
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 1.4 ì •ê¸° ê²°ì œ
- **ì¼€ì´ìŠ¤**: ë§¤ì›” ê²°ì œì¼ì— ìë™ ê²°ì œ
- **ì²˜ë¦¬**:
  - ë¹Œë§í‚¤ë¡œ ìë™ ê²°ì œ ì‹œë„
  - ì„±ê³µ: `currentPeriodStart`, `currentPeriodEnd` ì—…ë°ì´íŠ¸, payments ì»¬ë ‰ì…˜ì— ê²°ì œ ë‚´ì—­ ì €ì¥
  - ì‹¤íŒ¨: Dunning í”„ë¡œì„¸ìŠ¤ ì‹œì‘ (3íšŒ ì¬ì‹œë„)
- **ìë™í™”**:
  - Vercel Cron Jobìœ¼ë¡œ ë§¤ì¼ 00:00 KST ì‹¤í–‰
  - N8N ì›¹í›…ìœ¼ë¡œ ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
  - tenants ì»¬ë ‰ì…˜ ìë™ ë™ê¸°í™”
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

---

## 2. í”Œëœ ë³€ê²½ ì‹œë‚˜ë¦¬ì˜¤

### 2.1 í”Œëœ ì •ë³´
| í”Œëœ | ì›” ê°€ê²© (VAT í¬í•¨) |
|------|-------------------|
| Trial | 0ì› |
| Basic | 39,000ì› |
| Business | 99,000ì› |

### 2.2 ì—…ê·¸ë ˆì´ë“œ (ì¦‰ì‹œ)
- **ì¼€ì´ìŠ¤**: Basic â†’ Business í”Œëœ ë³€ê²½
- **ê³„ì‚° ë¡œì§** (ê¸°ì¡´ í”Œëœ ë¶€ë¶„ í™˜ë¶ˆ + ìƒˆ í”Œëœ ê²°ì œ ë¶„ë¦¬):
  ```
  ë‚¨ì€ ì¼ìˆ˜ = currentPeriodEnd - ì˜¤ëŠ˜
  ì´ ì¼ìˆ˜ = currentPeriodEnd - currentPeriodStart

  ê¸°ì¡´ í”Œëœ í™˜ë¶ˆì•¡ = (í˜„ì¬ í”Œëœ ê°€ê²© / ì´ ì¼ìˆ˜) Ã— ë‚¨ì€ ì¼ìˆ˜
  ìƒˆ í”Œëœ ê²°ì œì•¡ = (ìƒˆ í”Œëœ ê°€ê²© / ì´ ì¼ìˆ˜) Ã— (ë‚¨ì€ ì¼ìˆ˜ + 1)
  ```
- **ì²˜ë¦¬**:
  1. ê¸°ì¡´ í”Œëœ ë¶€ë¶„ í™˜ë¶ˆ (Toss cancelPayment)
  2. ìƒˆ í”Œëœ ì¼í•  ê²°ì œ (Toss ë¹Œë§í‚¤ ê²°ì œ)
  3. `plan`, `amount` ì¦‰ì‹œ ë³€ê²½
  4. `previousPlan`, `previousAmount` ì €ì¥
  5. payments ì»¬ë ‰ì…˜ì— í™˜ë¶ˆ/ê²°ì œ ë‚´ì—­ ì €ì¥
  6. tenants ì»¬ë ‰ì…˜ ë™ê¸°í™”
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 2.3 ë‹¤ìš´ê·¸ë ˆì´ë“œ (ì¦‰ì‹œ)
- **ì¼€ì´ìŠ¤**: Business â†’ Basic í”Œëœ ë³€ê²½
- **ê³„ì‚° ë¡œì§**:
  ```
  í™˜ë¶ˆ ê¸ˆì•¡ = ê¸°ì¡´ í”Œëœ í™˜ë¶ˆì•¡ - ìƒˆ í”Œëœ ê²°ì œì•¡
  ```
- **ì²˜ë¦¬**:
  - Toss Payments APIë¡œ ë¶€ë¶„ í™˜ë¶ˆ ìš”ì²­
  - `plan`, `amount` ì¦‰ì‹œ ë³€ê²½
  - payments ì»¬ë ‰ì…˜ì— í™˜ë¶ˆ ë‚´ì—­ ì €ì¥ (`type: 'downgrade_refund'`)
  - `originalPaymentId` ì—°ê²°
  - refunds ì»¬ë ‰ì…˜ì—ë„ í™˜ë¶ˆ ë‚´ì—­ ì €ì¥
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 2.4 í”Œëœ ë³€ê²½ ì˜ˆì•½ (ë‹¤ìŒ ê²°ì œì¼ë¶€í„° ì ìš©)
- **ì¼€ì´ìŠ¤**: ì‚¬ìš©ìê°€ ì¦‰ì‹œ ë³€ê²½ì´ ì•„ë‹Œ ì˜ˆì•½ ì„ íƒ
- **ì²˜ë¦¬**:
  - `pendingPlan`, `pendingAmount`, `pendingMode` í•„ë“œì— ì €ì¥
  - `pendingChangeAt` = nextBillingDate
  - í˜„ì¬ êµ¬ë…ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
  - ë‹¤ìŒ ê²°ì œì¼ì— ìë™ìœ¼ë¡œ í”Œëœ ë³€ê²½ + ìƒˆ ê¸ˆì•¡ ê²°ì œ
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 2.5 ì—£ì§€ ì¼€ì´ìŠ¤: ê²°ì œ ì£¼ê¸° ë§ˆì§€ë§‰ ë‚  ë³€ê²½
- **ì¼€ì´ìŠ¤**: currentPeriodEnd - 1ì¼ì— í”Œëœ ë³€ê²½
- **ë¬¸ì œì **: ë‚¨ì€ ì¼ìˆ˜ê°€ 0ì¼ ë˜ëŠ” 1ì¼
- **ì²˜ë¦¬**:
  - ë‚¨ì€ ì¼ìˆ˜ 0ì¼: ìƒˆ í”Œëœ 1ì¼ì¹˜ë§Œ ê²°ì œ (daysLeft + 1 = 1ì¼)
  - ì—…ê·¸ë ˆì´ë“œ: ìƒˆ í”Œëœ 1ì¼ì¹˜ ê²°ì œ
  - ë‹¤ìš´ê·¸ë ˆì´ë“œ: í™˜ë¶ˆ ì—†ì´ í”Œëœë§Œ ë³€ê²½
  - í† ìŠ¤ ìµœì†Œ ê²°ì œì•¡(100ì›)ì€ í”Œëœ ê°€ê²©(39,000ì›~)ìœ¼ë¡œ ì¸í•´ ë¬¸ì œì—†ìŒ
- **êµ¬í˜„ ìƒíƒœ**: âœ… êµ¬í˜„ë¨

### 2.6 ì—£ì§€ ì¼€ì´ìŠ¤: ê²°ì œ ì£¼ê¸° ì²«ë‚  ë³€ê²½
- **ì¼€ì´ìŠ¤**: ë°©ê¸ˆ ê²°ì œí•˜ê³  ë°”ë¡œ í”Œëœ ë³€ê²½
- **ê³„ì‚° ë¡œì§** (30ì¼ ê¸°ì¤€):
  - í˜„ì¬ í”Œëœ: 1ì¼ ì‚¬ìš©ìœ¼ë¡œ ê°„ì£¼, 29ì¼ì¹˜ í™˜ë¶ˆ
  - ìƒˆ í”Œëœ: ì „ì²´ ê¸°ê°„(30ì¼) ê²°ì œ
  - ì‹¤ì œ ì°¨ì•¡: `ìƒˆ í”Œëœ 30ì¼ì¹˜ - í˜„ì¬ í”Œëœ 29ì¼ì¹˜`
- **ì²˜ë¦¬**:
  - ì‚¬ìš©ìê°€ 1ì¼ ì´ìš©ë£Œë§Œ ì§€ë¶ˆí•˜ê³  í”Œëœ ë³€ê²½ ê°€ëŠ¥
  - ê³µì •í•œ ê³„ì‚°ìœ¼ë¡œ ì†í•´ ì—†ì´ ë³€ê²½ ê°€ëŠ¥
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

---

## 3. êµ¬ë… í•´ì§€ ì‹œë‚˜ë¦¬ì˜¤

### 3.1 ê¸°ê°„ ì¢…ë£Œ í›„ í•´ì§€ (Scheduled)
- **ì¼€ì´ìŠ¤**: ì‚¬ìš©ìê°€ í•´ì§€ ì‹ ì²­, í˜„ì¬ ê¸°ê°„ì€ ìœ ì§€
- **ì²˜ë¦¬**:
  - êµ¬ë… ìƒíƒœ: `canceled`
  - `canceledAt`, `cancelReason`, `cancelMode: 'scheduled'` ì €ì¥
  - `currentPeriodEnd`ê¹Œì§€ ì„œë¹„ìŠ¤ ì´ìš© ê°€ëŠ¥
  - ë‹¤ìŒ ìë™ ê²°ì œ ì¤‘ë‹¨
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 3.2 ì¦‰ì‹œ í•´ì§€ (Immediate)
- **ì¼€ì´ìŠ¤**: ì‚¬ìš©ìê°€ ì¦‰ì‹œ í•´ì§€ + í™˜ë¶ˆ ìš”ì²­
- **ê³„ì‚° ë¡œì§**:
  ```
  ë‚¨ì€ ì¼ìˆ˜ = currentPeriodEnd - ì˜¤ëŠ˜
  í™˜ë¶ˆ ê¸ˆì•¡ = (ê²°ì œ ê¸ˆì•¡ / ì´ ì¼ìˆ˜) Ã— ë‚¨ì€ ì¼ìˆ˜
  ```
- **ì²˜ë¦¬**:
  - Toss Payments APIë¡œ ë¶€ë¶„ í™˜ë¶ˆ
  - êµ¬ë… ìƒíƒœ: `expired`
  - `expiredAt` = ì˜¤ëŠ˜
  - `currentPeriodEnd` = ì˜¤ëŠ˜ (ì‹¤ì œ ì¢…ë£Œì¼ ì—…ë°ì´íŠ¸)
  - ì¦‰ì‹œ ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ë‹¨
  - payments ì»¬ë ‰ì…˜ì— í™˜ë¶ˆ ë‚´ì—­ ì €ì¥ (`type: 'cancel_refund'`)
  - refunds ì»¬ë ‰ì…˜ì— í™˜ë¶ˆ ë‚´ì—­ ì €ì¥
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 3.3 í•´ì§€ ì·¨ì†Œ (êµ¬ë… ì¬í™œì„±í™”)
- **ì¼€ì´ìŠ¤**: í•´ì§€ ì˜ˆì•½ í›„ ë§ˆìŒ ë³€ê²½
- **ì¡°ê±´**: `status === 'canceled'` AND `currentPeriodEnd > ì˜¤ëŠ˜`
- **ì²˜ë¦¬**:
  - êµ¬ë… ìƒíƒœ: `canceled` â†’ `active`
  - `canceledAt`, `cancelReason` = null
  - `reactivatedAt` = ì˜¤ëŠ˜
  - tenants ì»¬ë ‰ì…˜ ë™ê¸°í™” (`syncSubscriptionReactivation`)
- **API**: `POST /api/subscriptions/reactivate`
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 3.4 í™˜ë¶ˆ ê³„ì‚° ì—£ì§€ ì¼€ì´ìŠ¤
#### 3.4.1 í”Œëœ ë³€ê²½ í›„ ì¦‰ì‹œ í•´ì§€
- **ë¬¸ì œ**: í”Œëœ ë³€ê²½ìœ¼ë¡œ ì¼í•  ê³„ì‚°ëœ ê¸ˆì•¡ìœ¼ë¡œ ê²°ì œí–ˆëŠ”ë°, `subscription.amount`ì—ëŠ” ì •ê°€ê°€ ì €ì¥ë¨
- **í•´ê²°**: `currentPeriodStart`ë¥¼ í”Œëœ ë³€ê²½ì¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì •í™•í•œ ê¸°ê°„ ê³„ì‚°
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

#### 3.4.2 ë§ˆì§€ë§‰ ë‚  ì¦‰ì‹œ í•´ì§€
- **ì¼€ì´ìŠ¤**: ê²°ì œ ì£¼ê¸° ë§ˆì§€ë§‰ ë‚  ì¦‰ì‹œ í•´ì§€
- **ì²˜ë¦¬**: í™˜ë¶ˆì•¡ = 0ì›
- **êµ¬í˜„ ìƒíƒœ**: âœ… ë¡œì§ìƒ ì²˜ë¦¬ë¨

#### 3.4.3 ê²°ì œ ì§í›„ ì¦‰ì‹œ í•´ì§€
- **ì¼€ì´ìŠ¤**: ê²°ì œí•˜ê³  ëª‡ ë¶„ ë‚´ë¡œ ì¦‰ì‹œ í•´ì§€
- **ì²˜ë¦¬**: ê±°ì˜ ì „ì•¡ í™˜ë¶ˆ
- **êµ¬í˜„ ìƒíƒœ**: âœ… ë¡œì§ìƒ ì²˜ë¦¬ë¨

---

## 4. ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬

### 4.1 Soft Decline (ì¼ì‹œì  ì‹¤íŒ¨)
- **ì›ì¸**: ì”ì•¡ ë¶€ì¡±, ì¼ì‹œì  ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, ì¹´ë“œì‚¬ ì‹œìŠ¤í…œ ì ê²€
- **ì²˜ë¦¬** (Dunning):
  1. **D+0 (1ì¼ì°¨, 1íšŒì°¨ ì‹¤íŒ¨)**:
     - `status = 'past_due'` (ì¦‰ì‹œ ë³€ê²½)
     - `retryCount = 1`
     - `gracePeriodUntil = D+6` ì„¤ì • (7ì¼ê°„ ìœ ì˜ˆ)
     - N8N: `payment_retry_1` ì´ë²¤íŠ¸ ì „ì†¡
  2. **D+1 (2ì¼ì°¨, 2íšŒì°¨ ì‹¤íŒ¨)**:
     - `status = 'past_due'` ìœ ì§€
     - `retryCount = 2`
     - N8N: `payment_retry_2` ì´ë²¤íŠ¸ ì „ì†¡
  3. **D+2 (3ì¼ì°¨, 3íšŒì°¨ ì‹¤íŒ¨)**:
     - `status = 'past_due'` ìœ ì§€
     - `retryCount = 3`
     - N8N: `payment_failed_grace_period` ì´ë²¤íŠ¸ ì „ì†¡
  4. **D+3 ~ D+6 (4~7ì¼ì°¨, ìœ ì˜ˆ ê¸°ê°„)**:
     - ì„œë¹„ìŠ¤ ê³„ì† ì´ìš© ê°€ëŠ¥ (`status = 'past_due'`)
     - ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì¬ê²°ì œ ì‹œë„
  5. **D+7 (8ì¼ì°¨, ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ)**:
     - `status = 'suspended'` (ì„œë¹„ìŠ¤ ì¤‘ë‹¨)
     - tenants ë™ê¸°í™”: `syncSubscriptionSuspended()`
     - N8N: `grace_period_expired` ì´ë²¤íŠ¸ ì „ì†¡
- **ê³ ê° ì•Œë¦¼** (N8N ì›¹í›…):
  - 1~2íšŒ ì‹¤íŒ¨: `payment_retry_1`, `payment_retry_2`
  - 3íšŒ ì‹¤íŒ¨: `payment_failed_grace_period`
  - ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ: `grace_period_expired`
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ (Vercel Cron, ì›¹í›… ë°œì†¡), â³ N8N ì›Œí¬í”Œë¡œìš° ë¯¸ì„¤ì •

### 4.2 ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì¬ê²°ì œ
- **ì¼€ì´ìŠ¤**: ê²°ì œ ì‹¤íŒ¨ ìƒíƒœ(`past_due`)ì—ì„œ ì¹´ë“œ ë³€ê²½
- **ì²˜ë¦¬**:
  - ìƒˆ ì¹´ë“œë¡œ ì¦‰ì‹œ ì¬ê²°ì œ ì‹œë„
  - ì„±ê³µ ì‹œ:
    - `status = 'active'` ë³µêµ¬
    - `retryCount = 0` ì´ˆê¸°í™”
    - `gracePeriodUntil = null` ì œê±°
    - `currentPeriodStart = today`, `nextBillingDate = today + 1ê°œì›”`
    - payments ì €ì¥ (`type: 'card_update_retry'`)
    - N8N: `card_update_retry_success` ì´ë²¤íŠ¸ ì „ì†¡
  - ì‹¤íŒ¨ ì‹œ: ë‹¤ìŒ ì •ê¸° ì¬ì‹œë„ ì¼ì •ì— ë”°ë¼ ì§„í–‰
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 4.3 ìœ ì˜ˆ ê¸°ê°„ (Grace Period)
- **ì •ì˜**: ê²°ì œ 1íšŒ ì‹¤íŒ¨ë¶€í„° 7ì¼ê°„ ì„œë¹„ìŠ¤ ì´ìš© ê°€ëŠ¥
- **ê¸°ê°„**: 7ì¼ (D+0 ~ D+6, ì´ 7ì¼)
- **ìƒíƒœ**: `status = 'past_due'` + `gracePeriodUntil = D+6` ì„¤ì •
- **ì²˜ë¦¬**:
  - 1íšŒ ì‹¤íŒ¨ ì‹œ ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘
  - D+0, D+1, D+2ì— ì¬ì‹œë„ (3íšŒ)
  - D+7 (8ì¼ì°¨)ì— ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ ì‹œ `status = 'suspended'`ë¡œ ë³€ê²½
  - ìœ ì˜ˆ ê¸°ê°„ ì¤‘ ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì´ìš© ê°€ëŠ¥
  - UIì— ê²½ê³  ë°°ë„ˆ í‘œì‹œ (ê¶Œì¥)
  - ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì¬ê²°ì œ
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

---

## 5. ì—£ì§€ ì¼€ì´ìŠ¤

### 5.1 ë™ì‹œì„± ë¬¸ì œ
#### 5.1.1 í”Œëœ ë³€ê²½ + í•´ì§€ ë™ì‹œ í´ë¦­
- **ë¬¸ì œ**: ê°™ì€ ì‹œê°„ì— ë‘ ìš”ì²­ì´ ë“¤ì–´ì˜´
- **í•´ê²°ì±…**:
  - DB íŠ¸ëœì­ì…˜ ì‚¬ìš© (í˜„ì¬ êµ¬í˜„ë¨)
  - Optimistic Locking: `subscription` ë¬¸ì„œì— `version` í•„ë“œ ì¶”ê°€
  ```typescript
  transaction.update(subscriptionRef, {
    version: currentVersion + 1,
    ...otherFields
  });
  // versionì´ ë§ì§€ ì•Šìœ¼ë©´ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨
  ```
- **êµ¬í˜„ ìƒíƒœ**: âš ï¸ íŠ¸ëœì­ì…˜ë§Œ ìˆìŒ

#### 5.1.2 ì¤‘ë³µ ê²°ì œ ìš”ì²­
- **ë¬¸ì œ**: ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ â†’ ì‚¬ìš©ìê°€ ì¬ì‹œë„ ë²„íŠ¼ í´ë¦­ â†’ ì¤‘ë³µ ê²°ì œ
- **í•´ê²°ì±…**: ë©±ë“±ì„± í‚¤(Idempotency Key) ì‚¬ìš©
  ```typescript
  // í”„ë¡ íŠ¸ì—”ë“œ: ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ í‚¤ ìƒì„±
  const idempotencyKey = `${operation}_${tenantId}_${Date.now()}`;

  // ë°±ì—”ë“œ: lib/idempotency.ts
  const existingPayment = await findExistingPayment(db, idempotencyKey);
  if (existingPayment) {
    return existingPayment; // ê¸°ì¡´ ê²°ê³¼ ë°˜í™˜
  }
  ```
- **ì ìš© API**:
  - `/api/payments/confirm` - ì²« ê²°ì œ í™•ì •
  - `/api/payments/billing-confirm` - ë¹Œë§í‚¤ ê²°ì œ í™•ì •
  - `/api/payments/change-plan` - í”Œëœ ë³€ê²½ ê²°ì œ
  - `/api/payments/immediate-convert` - ì¦‰ì‹œ ì „í™˜ ê²°ì œ
  - `/api/subscriptions/change-plan` - ë‹¤ìš´ê·¸ë ˆì´ë“œ í™˜ë¶ˆ
  - `/api/cron/billing` - ì •ê¸° ê²°ì œ (ë‚ ì§œ ê¸°ë°˜ í‚¤)
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 5.2 Toss Paymentsì™€ DB ìƒíƒœ ë¶ˆì¼ì¹˜
#### 5.2.1 Toss ê²°ì œ ì„±ê³µ â†’ DB ì €ì¥ ì‹¤íŒ¨
- **ë¬¸ì œ**: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
- **í•´ê²°ì±…**: Webhookìœ¼ë¡œ Tossì—ì„œ ê²°ì œ ì™„ë£Œ ì•Œë¦¼ ìˆ˜ì‹  ì‹œ ì¬ì²˜ë¦¬
- **êµ¬í˜„ ìƒíƒœ**: âœ… Webhook êµ¬í˜„ë¨

#### 5.2.2 Toss í™˜ë¶ˆ ì„±ê³µ â†’ DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
- **ë¬¸ì œ**: í™˜ë¶ˆì€ ëëŠ”ë° DBì—ëŠ” ë°˜ì˜ ì•ˆ ë¨
- **í•´ê²°ì±…**:
  - Webhookì—ì„œ í™˜ë¶ˆ ì•Œë¦¼ ìˆ˜ì‹ 
  - ìˆ˜ë™ ê´€ë¦¬ì ë„êµ¬ë¡œ ë™ê¸°í™”
- **êµ¬í˜„ ìƒíƒœ**: âš ï¸ Webhook ìˆì§€ë§Œ í™˜ë¶ˆ ì²˜ë¦¬ í™•ì¸ í•„ìš”

### 5.3 ë‚ ì§œ/ì‹œê°„ ê²½ê³„ ì¼€ì´ìŠ¤
#### 5.3.1 ì›”ë§ â†’ ë‹¤ìŒ ë‹¬ ì²˜ë¦¬
- **ì˜ˆì‹œ**: 1ì›” 31ì¼ êµ¬ë… â†’ 2ì›” ê²°ì œì¼ì€?
  - Option 1: 2ì›” 28ì¼ (ë‹¬ë§ˆë‹¤ ë‹¤ë¦„)
  - Option 2: ë§¤ì›” ë§ˆì§€ë§‰ ë‚ 
  - Option 3: ë‹¤ìŒ ë‹¬ 1ì¼
- **í˜„ì¬ êµ¬í˜„**: ì›” ë‹¨ìœ„ë¡œ +1ê°œì›” (JavaScript `setMonth`)
- **êµ¬í˜„ ìƒíƒœ**: âœ… êµ¬í˜„ë¨

#### 5.3.2 ì‹œê°„ëŒ€ (Timezone) ì²˜ë¦¬
- **ë¬¸ì œ**: ì„œë²„ ì‹œê°„(UTC) vs ì‚¬ìš©ì ì‹œê°„ëŒ€ (KST)
- **í•´ê²°ì±…**: ëª¨ë“  ì‹œê°„ì„ UTCë¡œ ì €ì¥, í‘œì‹œë§Œ ì‚¬ìš©ì ì‹œê°„ëŒ€
- **êµ¬í˜„ ìƒíƒœ**: âš ï¸ í™•ì¸ í•„ìš”

#### 5.3.3 ì¼ê´‘ ì ˆì•½ ì‹œê°„ (DST)
- **ë¬¸ì œ**: íŠ¹ì • êµ­ê°€ì—ì„œ ì‹œê°„ì´ 1ì‹œê°„ ë³€ê²½
- **í•´ê²°ì±…**: UTC ê¸°ì¤€ìœ¼ë¡œ ì €ì¥
- **êµ¬í˜„ ìƒíƒœ**: N/A (í•œêµ­ì€ DST ì—†ìŒ)

### 5.4 í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜
#### 5.4.1 ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼ ì˜¤ë¥˜
- **ë¬¸ì œ**: ì¼í•  ê³„ì‚° ì‹œ ì†Œìˆ˜ì  ëˆ„ì  ì˜¤ë¥˜
- **ì˜ˆì‹œ**:
  ```
  39,000ì› / 30ì¼ = 1,300ì›/ì¼
  1,300ì› Ã— 29ì¼ = 37,700ì›
  ì‹¤ì œ í™˜ë¶ˆ: 37,700ì› (ì •í™•í•¨)

  í•˜ì§€ë§Œ float ê³„ì‚° ì‹œ:
  (39000 / 30) * 29 = 37,699.999...
  Math.round() = 37,700 âœ…
  Math.floor() = 37,699 âŒ (100ì› ì†í•´)
  ```
- **í•´ê²°ì±…**: í•­ìƒ `Math.round()` ë˜ëŠ” `Math.floor()` ì¼ê´€ë˜ê²Œ ì‚¬ìš©
- **êµ¬í˜„ ìƒíƒœ**: âœ… `Math.round()` ì‚¬ìš© ì¤‘

#### 5.4.2 ìŒìˆ˜ í™˜ë¶ˆ ê¸ˆì•¡ ë° 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
- **ì¼€ì´ìŠ¤ 1**: ê³„ì‚° ì˜¤ë¥˜ë¡œ í™˜ë¶ˆì•¡ì´ ìŒìˆ˜
- **í•´ê²°ì±… 1**: `Math.max(0, refundAmount)` ì²´í¬
- **ì¼€ì´ìŠ¤ 2**: `totalDays`ê°€ 0ì¼ ë•Œ 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ì˜¤ë¥˜
- **í•´ê²°ì±… 2**: `totalDays <= 0`ì´ë©´ 0ì› í™˜ë¶ˆ ë˜ëŠ” ì „ì•¡ í™˜ë¶ˆ ì²˜ë¦¬
  ```typescript
  // í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚° ì‹œ
  if (totalDays <= 0) {
    return 0; // ë˜ëŠ” ì „ì•¡ í™˜ë¶ˆ
  }
  const dailyRate = amount / totalDays;
  const refundAmount = Math.round(dailyRate * daysLeft);
  ```
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

### 5.5 ê²°ì œ ìˆ˜ë‹¨ ë³€ê²½
#### 5.5.1 êµ¬ë… ì¤‘ ì¹´ë“œ ë³€ê²½
- **ì²˜ë¦¬**:
  - ìƒˆ ì¹´ë“œë¡œ ë¹Œë§í‚¤ ë°œê¸‰
  - ê¸°ì¡´ ë¹Œë§í‚¤ ë¹„í™œì„±í™”
  - ë‹¤ìŒ ê²°ì œë¶€í„° ìƒˆ ì¹´ë“œ ì‚¬ìš©
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

#### 5.5.2 ì¹´ë“œ ë§Œë£Œ ì „ ê°±ì‹ 
- **ì²˜ë¦¬**:
  - ë§Œë£Œ 30ì¼ ì „, 7ì¼ ì „ N8N ì›¹í›… ì•Œë¦¼ (`card_expiring_soon`)
  - ì‚¬ìš©ìì—ê²Œ ì¹´ë“œ ê°±ì‹  ì•ˆë‚´
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ (Vercel Cron + N8N)

### 5.6 ì„¸ê¸ˆ/VAT ì²˜ë¦¬
- **ì ìš© ë²”ìœ„**: í•œêµ­ ì‹œì¥ ì „ìš© (êµ­ì œ ê²°ì œ ì—†ìŒ)
- **ì„¸ê¸ˆìœ¨**: 10% VAT (ë¶€ê°€ê°€ì¹˜ì„¸)
- **ê°€ê²© í‘œì‹œ**: ëª¨ë“  ê¸ˆì•¡ì€ VAT í¬í•¨ ê°€ê²©
  - Basic í”Œëœ: 39,000ì›/ì›” (VAT í¬í•¨)
  - Business í”Œëœ: 99,000ì›/ì›” (VAT í¬í•¨)
- **ì„¸ê¸ˆ ë³€ê²½**: í•„ìš” ì—†ìŒ (ê³ ì • ì„¸ìœ¨)
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ (Toss Payments ìë™ ì²˜ë¦¬)

### 5.7 ì¿ í°/í”„ë¡œëª¨ì…˜ ì½”ë“œ
#### 5.7.1 ì²« ë‹¬ 50% í• ì¸
- **ì²˜ë¦¬**:
  - `discountAmount` í•„ë“œ ì¶”ê°€
  - ì²« ê²°ì œë§Œ í• ì¸ ì ìš©
  - ë‘ ë²ˆì§¸ ê²°ì œë¶€í„° ì •ìƒ ê¸ˆì•¡
- **êµ¬í˜„ ìƒíƒœ**: âŒ ë¯¸êµ¬í˜„ (êµ¬í˜„ ê³„íš ì•„ì§ ì—†ìŒ)

#### 5.7.2 ì—°ê°„ êµ¬ë… í• ì¸
- **ì²˜ë¦¬**:
  - 12ê°œì›” ê¸ˆì•¡ì˜ 80%ë¡œ ì—°ê°„ ê²°ì œ
  - `billingCycle: 'yearly'`
- **êµ¬í˜„ ìƒíƒœ**: âŒ ë¯¸êµ¬í˜„ (êµ¬í˜„ ê³„íš ì•„ì§ ì—†ìŒ)

### 5.8 ê°€ê²© ì •ì±… (Price Policy)
- **íƒ€ì…**: `grandfathered` | `protected_until` | `standard`
- **ì„¤ëª…**:
  - `grandfathered`: ê°€ê²© ë³´í˜¸ (ì˜êµ¬) - ê¸°ì¡´ ê°€ê²© í‰ìƒ ìœ ì§€
  - `protected_until`: ê¸°ê°„ í•œì • ê°€ê²© ë³´í˜¸ - íŠ¹ì • ë‚ ì§œê¹Œì§€ ê¸°ì¡´ ê°€ê²© ìœ ì§€
  - `standard`: ì¼ë°˜ (ìµœì‹  ê°€ê²© ì ìš©)
- **êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ (`lib/toss.ts`)

---

## 6. ë§¤ì¥ ì‚­ì œ / íšŒì› íƒˆí‡´

### 6.1 ë§¤ì¥ ì‚­ì œ (Tenant Deletion)

**API**: `DELETE /api/tenants/[tenantId]` (ì‚¬ìš©ì) / `DELETE /api/admin/tenants/[tenantId]` (ê´€ë¦¬ì)

#### ì‚­ì œ ì¡°ê±´
- êµ¬ë… ìƒíƒœê°€ `expired`ì´ê±°ë‚˜ êµ¬ë…ì´ ì—†ëŠ” ê²½ìš°ë§Œ ì‚­ì œ ê°€ëŠ¥
- ì‚­ì œ ë¶ˆê°€ ìƒíƒœ: `trial`, `active`, `canceled`, `past_due`

#### ì²˜ë¦¬ ë°©ì‹: **Soft Delete**

**tenants ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸:**
```typescript
{
  deleted: true,
  deletedAt: Date,
  deletedBy: email | 'admin',
  permanentDeleteAt: Date, // 90ì¼ í›„
  updatedAt: serverTimestamp
}
```

**tenant_deletions ì»¬ë ‰ì…˜ ì¶”ê°€ (ë¡œê·¸):**
```typescript
{
  tenantId: string,
  brandName: string,
  email: string,
  deletedAt: Date,
  permanentDeleteAt: Date, // 90ì¼ í›„
  reason: 'user_request' | 'admin_delete'
}
```

#### íŠ¹ì§•
- ë§¤ì¥ ë°ì´í„° ìì²´ëŠ” ì‚­ì œí•˜ì§€ ì•Šê³  `deleted: true` í‘œì‹œ
- `permanentDeleteAt` (90ì¼ í›„)ê¹Œì§€ ë³µêµ¬ ê°€ëŠ¥ ê¸°ê°„
- ì¶”í›„ ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ `permanentDeleteAt` ì§€ë‚œ ë°ì´í„° ì˜êµ¬ ì‚­ì œ ì˜ˆì •

**êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

---

### 6.2 íšŒì› íƒˆí‡´ (Account Deletion)

**API**: `DELETE /api/account/delete`

#### íƒˆí‡´ ì¡°ê±´
- ëª¨ë“  ë§¤ì¥ì´ êµ¬ë…/ì²´í—˜ ì¢…ë£Œ ìƒíƒœì—¬ì•¼ í•¨
- íƒˆí‡´ ë¶ˆê°€: `active`, `trial`, `canceled` ìƒíƒœì˜ êµ¬ë…ì´ ìˆëŠ” ê²½ìš°

#### ì²˜ë¦¬ ë°©ì‹: **Soft Delete + ë²•ë ¹ ì¤€ìˆ˜ ë³´ê´€**

**1) tenants ì»¬ë ‰ì…˜:**
```typescript
{
  deleted: true,
  deletedAt: Date,
  deletedEmail: 'ì›ë³¸ ì´ë©”ì¼',
  email: 'deleted_{timestamp}_{email}' // ë§ˆìŠ¤í‚¹
}
```

**2) subscriptions ì»¬ë ‰ì…˜:**
```typescript
{
  deleted: true,
  deletedAt: Date
}
```

**3) cards ì»¬ë ‰ì…˜:** **ì™„ì „ ì‚­ì œ** (ì¹´ë“œ ì •ë³´ëŠ” ë³´ê´€ ë¶ˆí•„ìš”)

**4) users ì»¬ë ‰ì…˜:** (ê²°ì œ ì´ë ¥ì— ë”°ë¼ ë³´ê´€ ê¸°ê°„ ì°¨ë“±)
```typescript
{
  deleted: true,
  deletedAt: Date,
  retentionEndDate: Date,
  retentionReason: 'ì „ììƒê±°ë˜ë²•_5ë…„' | 'ë¶€ì •ì´ìš©ë°©ì§€_1ë…„',
  // email, phone, name, trialApplied ëª¨ë‘ ìœ ì§€
  // - deleted ìƒíƒœë¼ ì‹ ê·œ ê°€ì…ì€ ê°€ëŠ¥
  // - phoneìœ¼ë¡œ ë¬´ë£Œì²´í—˜ ì´ë ¥ ì¶”ì 
}
```

| ìœ í˜• | ë³´ê´€ ê¸°ê°„ | ê·¼ê±° |
|------|----------|------|
| ê²°ì œ ê³ ê° | 5ë…„ | ì „ììƒê±°ë˜ë²• |
| ë¬´ë£Œì²´í—˜ë§Œ | 1ë…„ | ë¶€ì • ì´ìš© ë°©ì§€ |

**5) account_deletions ì»¬ë ‰ì…˜ ì¶”ê°€ (ë¡œê·¸):**
```typescript
{
  email: string,
  tenantIds: string[],
  deletedAt: Date,
  reason: 'User requested deletion'
}
```

**6) N8N ì›¹í›… í˜¸ì¶œ:** `account_deleted` ì´ë²¤íŠ¸

**êµ¬í˜„ ìƒíƒœ**: âœ… ì™„ë£Œ

---

### 6.3 ì¬ê°€ì…/ë³µêµ¬ ê´€ë ¨

| í•­ëª© | ì²˜ë¦¬ |
|------|------|
| ë§¤ì¥ ë³µêµ¬ | `permanentDeleteAt` ì´ì „ì— ê´€ë¦¬ìê°€ `deleted: false`ë¡œ ë³€ê²½ |
| íšŒì› ì¬ê°€ì… | `deleted: true`ì¸ ì´ë©”ì¼ë¡œ ì¬ê°€ì… ê°€ëŠ¥ (ì‹ ê·œ ê°€ì… ì·¨ê¸‰) |
| ë¬´ë£Œì²´í—˜ ì¤‘ë³µ ë°©ì§€ | `phone` ê¸°ì¤€ìœ¼ë¡œ `trialApplied` ì²´í¬ |

---

## 7. í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥

#### êµ¬ë… ê´€ë¦¬
1. **ë¬´ë£Œ ì²´í—˜ ì‹œì‘ ë° ê´€ë¦¬**
   - ì¹´ë“œ ë“±ë¡ ì—†ì´ ì²´í—˜ ì‹œì‘
   - ë¹Œë§í‚¤ëŠ” ìœ ë£Œ ì „í™˜ ì‹œì ì— ë“±ë¡
2. **ë¬´ë£Œ ì²´í—˜ â†’ ìœ ë£Œ ì „í™˜**
   - ì¦‰ì‹œ ì „í™˜: ì¹´ë“œ ë“±ë¡ + ì¦‰ì‹œ ê²°ì œ
   - ì˜ˆì•½ ì „í™˜: `pendingPlan` ì €ì¥ â†’ ì²´í—˜ ì¢…ë£Œì¼ì— ìë™ ì „í™˜
3. **í”Œëœ ì—…ê·¸ë ˆì´ë“œ/ë‹¤ìš´ê·¸ë ˆì´ë“œ (ì¦‰ì‹œ)**
   - ì¼í•  ê³„ì‚° í™˜ë¶ˆ/ê²°ì œ (ê¸°ì¡´ í™˜ë¶ˆ + ìƒˆ ê²°ì œ ë¶„ë¦¬)
   - `currentPeriodStart` ì—…ë°ì´íŠ¸ë¡œ ì •í™•í•œ í™˜ë¶ˆ ê³„ì‚°
   - íŠ¸ëœì­ì…˜ ê¸°ë°˜ ì›ìì„± ë³´ì¥
4. **í”Œëœ ë³€ê²½ ì˜ˆì•½ (ë‹¤ìŒ ê²°ì œì¼ë¶€í„°)**
   - `pendingPlan`, `pendingAmount`, `pendingMode` ì €ì¥
   - Cron Jobì—ì„œ ìë™ ì ìš©
5. **êµ¬ë… í•´ì§€**
   - ì˜ˆì•½ í•´ì§€: `currentPeriodEnd`ê¹Œì§€ ì´ìš© ê°€ëŠ¥
   - ì¦‰ì‹œ í•´ì§€: ì¼í•  í™˜ë¶ˆ + ì¦‰ì‹œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨
   - í™˜ë¶ˆ ë‚´ì—­ ì €ì¥ (`type: 'cancel_refund'`, `originalPaymentId` ì—°ê²°)
6. **êµ¬ë… ì¬í™œì„±í™”**
   - í•´ì§€ ì˜ˆì•½ ìƒíƒœì—ì„œ ì¬í™œì„±í™” ê°€ëŠ¥
   - `status: 'canceled' â†’ 'active'`

#### ê²°ì œ ìë™í™” (Vercel Cron Job)
7. **ì •ê¸° ê²°ì œ ìë™ ì²˜ë¦¬**
   - ì‹¤í–‰ ì£¼ê¸°: ë§¤ì¼ 00:00 KST (`vercel.json`)
   - Firebase Composite Index ì„¤ì • ì™„ë£Œ
   - CRON_SECRET ì¸ì¦ ì ìš©
8. **ë¬´ë£Œì²´í—˜ ë§Œë£Œ ì²˜ë¦¬**
   - `pendingPlan` ìˆìœ¼ë©´: ìë™ ì „í™˜ + ì²« ê²°ì œ
   - `pendingPlan` ì—†ìœ¼ë©´: `status = 'expired'`
9. **ì¹´ë“œ ë§Œë£Œ ì‚¬ì „ ì•Œë¦¼**
   - 30ì¼ ì „, 7ì¼ ì „ ì•Œë¦¼ ì „ì†¡
10. **ì˜ˆì•½ í”Œëœ ë³€ê²½ ìë™ ì ìš©**
    - `pendingChangeAt` ë„ë‹¬ ì‹œ ìë™ ì ìš©
11. **ê²°ì œ ì‹¤íŒ¨ ì¬ì‹œë„ (Dunning) ë° ìœ ì˜ˆ ê¸°ê°„**
    - D+0, D+1, D+2 ì¬ì‹œë„ (3íšŒ)
    - 1íšŒ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ `status = 'past_due'` ë³€ê²½ ë° `gracePeriodUntil = D+6` ì„¤ì •
    - ìœ ì˜ˆ ê¸°ê°„: D+0 ~ D+6 (ì´ 7ì¼)
    - D+7 (8ì¼ì°¨)ì— ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ ì‹œ `status = 'suspended'`
    - ìœ ì˜ˆ ê¸°ê°„ ì¤‘ ì„œë¹„ìŠ¤ ê³„ì† ì´ìš© ê°€ëŠ¥
12. **ì¹´ë“œ ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì¬ê²°ì œ**
    - `past_due` ìƒíƒœì—ì„œ ì¹´ë“œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¬ê²°ì œ ì‹œë„
    - ì„±ê³µ ì‹œ `status = 'active'` ë³µêµ¬
    - ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì¬ì‹œë„ ì¼ì •ì— ë”°ë¼ ì§„í–‰

#### ë°ì´í„° ë™ê¸°í™” & ì•Œë¦¼
13. **tenants ì»¬ë ‰ì…˜ ìë™ ë™ê¸°í™”**
    - `syncNewSubscription`: ë¬´ë£Œì²´í—˜ ì „í™˜ ì‹œ
    - `syncTrialExpired`: ì²´í—˜ ë§Œë£Œ ì‹œ
    - `syncPlanChange`: í”Œëœ ë³€ê²½ ì‹œ
    - `syncPaymentSuccess`: ê²°ì œ ì„±ê³µ ì‹œ
    - `syncPaymentFailure`: ê²°ì œ ì‹¤íŒ¨ ì‹œ
    - `syncSubscriptionCancellation`: í•´ì§€ ì˜ˆì•½ ì‹œ
    - `syncSubscriptionReactivation`: êµ¬ë… ì¬í™œì„±í™” ì‹œ
    - `syncSubscriptionExpired`: êµ¬ë… ë§Œë£Œ ì‹œ
    - `syncSubscriptionSuspended`: ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ ì‹œ
14. **N8N ì›¹í›… ì•Œë¦¼** (âš ï¸ í˜„ì¬ ì•Œë¦¼ì„± ì›¹í›… ë¹„í™œì„±í™”ë¨)

    **í™œì„±í™”/ë¹„í™œì„±í™” ì„¤ì •**: `lib/n8n.ts`
    ```typescript
    export const ENABLE_N8N_NOTIFICATION_WEBHOOKS = false;  // trueë¡œ ë³€ê²½ ì‹œ í™œì„±í™”
    ```

    **í•­ìƒ í™œì„± (tenant/trial ìƒì„±ìš©):**
    - `trial/create` - ë¬´ë£Œì²´í—˜ ì‹ ì²­ â†’ n8nì—ì„œ tenant ìƒì„±
    - `trial/apply` - ê¸°ì¡´ ë§¤ì¥ì— ì²´í—˜ ì ìš©
    - `tenants/route` - ë§¤ì¥ ì¶”ê°€ â†’ n8nì—ì„œ tenant ìƒì„±

    **ë¹„í™œì„±í™”ëœ ì•Œë¦¼ ì›¹í›… (ENABLE_N8N_NOTIFICATION_WEBHOOKSë¡œ ì œì–´):**
    - `trial_expired`: ë¬´ë£Œì²´í—˜ ë§Œë£Œ
    - `card_expiring_soon`: ì¹´ë“œ ë§Œë£Œ ì„ë°• (30ì¼/7ì¼ ì „)
    - `pending_plan_applied`: ì˜ˆì•½ í”Œëœ ì ìš©
    - `recurring_payment_success`: ì •ê¸°ê²°ì œ ì„±ê³µ
    - `payment_retry_1`, `payment_retry_2`: ê²°ì œ ì¬ì‹œë„
    - `payment_failed_grace_period`: 3íšŒ ì‹¤íŒ¨ í›„ ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘
    - `grace_period_expired`: ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ
    - `card_update_retry_success`: ì¹´ë“œ ë³€ê²½ í›„ ìë™ ì¬ê²°ì œ ì„±ê³µ
    - `plan_changed_immediate`: ì¦‰ì‹œ í”Œëœ ë³€ê²½
    - `plan_change_scheduled`: ì˜ˆì•½ í”Œëœ ë³€ê²½
    - `subscription_canceled_immediate`: ì¦‰ì‹œ í•´ì§€
    - `subscription_canceled_scheduled`: ì˜ˆì•½ í•´ì§€
    - `account_deleted`: íšŒì› íƒˆí‡´

    **ì•Œë¦¼ ì›¹í›… í™œì„±í™” ë°©ë²•:**
    1. N8Nì—ì„œ ê° ì´ë²¤íŠ¸ ì²˜ë¦¬ ì›Œí¬í”Œë¡œìš° ìƒì„±
    2. `lib/n8n.ts`ì—ì„œ `ENABLE_N8N_NOTIFICATION_WEBHOOKS = true` ì„¤ì •
    3. í™˜ê²½ë³€ìˆ˜ `N8N_WEBHOOK_URL` í™•ì¸
15. **ê²°ì œ ë‚´ì—­ ìë™ ì €ì¥**
    - payments ì»¬ë ‰ì…˜ì— ëª¨ë“  ê²°ì œ ê¸°ë¡
    - type êµ¬ë¶„: `trial_conversion`, `upgrade`, `downgrade`, `downgrade_refund`, `recurring`, `card_update_retry`, `cancel_refund`

#### ê²°ì œ ì•ˆì •ì„±
16. **ì¤‘ë³µ ê²°ì œ ë°©ì§€ (ë©±ë“±ì„± í‚¤)**
    - `lib/idempotency.ts` í—¬í¼ í•¨ìˆ˜ êµ¬í˜„
    - í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê²°ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ê³ ìœ  í‚¤ ìƒì„±
    - ë°±ì—”ë“œì—ì„œ ë™ì¼ í‚¤ë¡œ ìš”ì²­ ì‹œ ê¸°ì¡´ ê²°ê³¼ ë°˜í™˜
    - ëª¨ë“  ê²°ì œ APIì— ì ìš© ì™„ë£Œ
17. **í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜ ë°©ì§€**
    - 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€ (`totalDays <= 0` ì²´í¬)
    - ìŒìˆ˜ í™˜ë¶ˆ ë°©ì§€ (`Math.max(0, refundAmount)`)

#### ë§¤ì¥/íšŒì› ê´€ë¦¬
18. **ë§¤ì¥ ì‚­ì œ (Soft Delete)**
    - 90ì¼ ë³´ê´€ í›„ ì˜êµ¬ ì‚­ì œ ì˜ˆì •
    - `tenant_deletions` ì»¬ë ‰ì…˜ì— ë¡œê·¸ ì €ì¥
19. **íšŒì› íƒˆí‡´ (Soft Delete)**
    - ê²°ì œ ì´ë ¥ì— ë”°ë¥¸ ì°¨ë“± ë³´ê´€ (5ë…„/1ë…„)
    - `account_deletions` ì»¬ë ‰ì…˜ì— ë¡œê·¸ ì €ì¥

#### UI/UX
20. **Toss Payments Webhook ì—°ë™**
21. **ê²°ì œ ë‚´ì—­ í‘œì‹œ (í™˜ë¶ˆ ë‚´ì—­ ì¤‘ì²© í‘œì‹œ)**
22. **ì·¨ì†Œ ëª¨ë‹¬ ê°œì„ **
    - 90ì¼ ë°ì´í„° ë³´ê´€ ì •ì±… ì•ˆë‚´
    - í™˜ë¶ˆ ê³„ì‚° ë‚´ì—­ ì¸í„°ë™í‹°ë¸Œ íˆ´íŒ
23. **êµ¬ë… ë‚´ì—­ ì •ë ¬ ê°œì„ **
    - ìƒíƒœ ìš°ì„ ìˆœìœ„: ì‚¬ìš©ì¤‘ > ì‚¬ìš©ì™„ë£Œ > í•´ì§€ë¨
24. **ê°€ê²© ì •ì±… (Price Policy)**
    - `grandfathered`, `protected_until`, `standard` ì§€ì›

### âš ï¸ ë¶€ë¶„ êµ¬í˜„
1. **ë™ì‹œì„± ì œì–´**: íŠ¸ëœì­ì…˜ì€ ìˆì§€ë§Œ Optimistic Locking ì—†ìŒ
2. **Toss-DB ìƒíƒœ ë™ê¸°í™”**: Webhookì€ ìˆì§€ë§Œ í™˜ë¶ˆ ì²˜ë¦¬ í™•ì¸ í•„ìš”
3. **ë‚ ì§œ ê²½ê³„ ì²˜ë¦¬**: ê¸°ë³¸ êµ¬í˜„ë¨, ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ í•„ìš”
4. **ë°ì´í„° ë³´ê´€ ì •ì±…**: UI ì•ˆë‚´ë§Œ ìˆìŒ, ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬ ì—†ìŒ
5. **N8N ì•Œë¦¼ ì›¹í›…**: ì½”ë“œ êµ¬í˜„ë¨, í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœ (`lib/n8n.ts`ì—ì„œ ì œì–´), N8N ì›Œí¬í”Œë¡œìš° ë¯¸ì„¤ì •

### âŒ ë¯¸êµ¬í˜„
1. **ì•Œë¦¼ ì´ë ¥ ê´€ë¦¬** (`payment_notifications` ì»¬ë ‰ì…˜ ë° ì¤‘ë³µ ë°©ì§€)
2. **ê²°ì œ ì£¼ê¸° ë§ˆì§€ë§‰ ë‚  í”Œëœ ë³€ê²½ ì œí•œ**
3. **ì¿ í°/í”„ë¡œëª¨ì…˜ ì½”ë“œ**
4. **ì—°ê°„ êµ¬ë…**
5. **ë°ì´í„° ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬** (ì•„ë˜ ì •ì±… ì°¸ê³ )

### ğŸ“‹ ë°ì´í„° ë³´ê´€ ì •ì±… (ê³„íš)

| ë°ì´í„° ìœ í˜• | ë³´ê´€ ê¸°ê°„ | ì‚­ì œ ì‹œì  | ë¹„ê³  |
|------------|----------|----------|------|
| ê²°ì œ/í™˜ë¶ˆ/êµ¬ë… ë‚´ì—­ | **5ë…„** | ìë™ ì‚­ì œ | ì „ììƒê±°ë˜ë²• |
| ë¬´ë£Œì²´í—˜ë§Œ ê³„ì • | **1ë…„** | ìë™ ì‚­ì œ | ë¶€ì • ì´ìš© ë°©ì§€ (phone ê¸°ì¤€) |
| ë§¤ì¥ ê¸°ë³¸ ì •ë³´ | **90ì¼** | ë§¤ì¥ ì‚­ì œ/íƒˆí‡´ ì‹œ ì¦‰ì‹œ | ë³µêµ¬ ë¶ˆê°€ |
| ì„œë¹„ìŠ¤ ë°ì´í„° (FAQ, ëŒ€í™” ë“±) | **90ì¼** | ë§¤ì¥ ì‚­ì œ/íƒˆí‡´ ì‹œ ì¦‰ì‹œ | ë³µêµ¬ ë¶ˆê°€ |
| ì¹´ë“œ ì •ë³´ | ì¦‰ì‹œ | íƒˆí‡´ ì‹œ ì¦‰ì‹œ | ì´ë¯¸ êµ¬í˜„ë¨ |

**ì£¼ìš” ì›ì¹™:**
- ê²°ì œ ê´€ë ¨ ë°ì´í„°ëŠ” ë²•ì  ìš”êµ¬ë¡œ ì ˆëŒ€ ì‚­ì œ ë¶ˆê°€
- ë§¤ì¥ ì‚­ì œ/ê³„ì • íƒˆí‡´ ì‹œ ì„œë¹„ìŠ¤ ë°ì´í„°ëŠ” ì¦‰ì‹œ ì‚­ì œ (ë³µêµ¬ ìš”ì²­ ë¶ˆê°€)
- ë¬´ë£Œì²´í—˜ ê³„ì •ì€ phone ê¸°ì¤€ ì¤‘ë³µ ì²´í¬ìš©ìœ¼ë¡œ 1ë…„ ë³´ê´€

---

## 8. Vercel Cron Job ìƒì„¸

### 8.1 ì„¤ì •
- **íŒŒì¼**: `vercel.json`
- **ì‹¤í–‰ ì£¼ê¸°**: ë§¤ì¼ 00:00 KST (15:00 UTC)
- **ì—”ë“œí¬ì¸íŠ¸**: `/api/cron/billing`
- **ì¸ì¦**: CRON_SECRET í™˜ê²½ë³€ìˆ˜ë¡œ ë³´í˜¸

### 8.2 ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤

#### Phase 1: ë¬´ë£Œì²´í—˜ ì²˜ë¦¬
```typescript
// trial ìƒíƒœ êµ¬ë… ì¡°íšŒ
subscriptions.where('status', '==', 'trial')

// trialEndDate <= ì˜¤ëŠ˜
if (pendingPlan && billingKey) {
  // ìë™ ì „í™˜ + ì²« ê²°ì œ
  status: 'trial' â†’ 'active'
  syncNewSubscription()
  N8N: 'trial_converted'
} else {
  // ë§Œë£Œ ì²˜ë¦¬
  status: 'trial' â†’ 'expired'
  syncTrialExpired()
  N8N: 'trial_expired'
}
```

#### Phase 2: ì¹´ë“œ ë§Œë£Œ ì•Œë¦¼
```typescript
// active êµ¬ë…ì˜ ì¹´ë“œ ë§Œë£Œì¼ ì²´í¬
if (daysUntilExpiry === 30 || daysUntilExpiry === 7) {
  N8N: 'card_expiring_soon'
}
```

#### Phase 3: ì˜ˆì•½ í”Œëœ ë³€ê²½
```typescript
// pendingMode === 'scheduled' êµ¬ë… ì¡°íšŒ
if (pendingChangeAt <= ì˜¤ëŠ˜) {
  plan: previousPlan â†’ pendingPlan
  amount: previousAmount â†’ pendingAmount
  pendingPlan = null
  syncPlanChange()
  N8N: 'pending_plan_applied'
}
```

#### Phase 4: ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ ì²˜ë¦¬
```typescript
// past_due ìƒíƒœ êµ¬ë… ì¡°íšŒ
subscriptions.where('status', '==', 'past_due')

// ìœ ì˜ˆ ê¸°ê°„ì´ ë§Œë£Œëœ êµ¬ë… ì°¾ê¸°
if (gracePeriodUntil && gracePeriodUntil < today) {
  // ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ - êµ¬ë… ì •ì§€ (D+7ì— ì¢…ë£Œ)
  status = 'suspended'
  suspendedAt = today
  syncSubscriptionSuspended()
  N8N: 'grace_period_expired'
}
```

#### Phase 5: ì •ê¸° ê²°ì œ
```typescript
// 1. active êµ¬ë… ì¡°íšŒ (nextBillingDate <= ì˜¤ëŠ˜)
activeSubscriptions
  .where('status', '==', 'active')
  .where('nextBillingDate', '<=', today)

// 2. past_due êµ¬ë… ì¤‘ ì¬ì‹œë„ ëŒ€ìƒ ì¡°íšŒ
pastDueSubscriptions
  .where('status', '==', 'past_due')
  .filter(retryCount < 3 && daysSinceFailure === retryCount)

// ê²°ì œ ì‹œë„
try {
  payWithBillingKey()
  // ì„±ê³µ
  status = 'active'
  nextBillingDate += 1ê°œì›”
  retryCount = 0
  gracePeriodUntil = null
  lastPaymentError = null
  payments.add({ type: 'recurring' })
  syncPaymentSuccess()
  N8N: 'recurring_payment_success'
} catch {
  // ì‹¤íŒ¨
  retryCount++

  // 1íšŒ ì‹¤íŒ¨ ì‹œ ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘
  if (retryCount === 1) {
    gracePeriodUntil = today + 6ì¼  // D+0ë¶€í„° D+6ê¹Œì§€ (7ì¼)
  }

  status = 'past_due'
  syncPaymentFailure()

  if (retryCount >= 3) {
    // 3íšŒ ì‹¤íŒ¨
    N8N: 'payment_failed_grace_period'
  } else {
    // 1~2íšŒ ì‹¤íŒ¨
    N8N: `payment_retry_${retryCount}`
  }
}
```

### 8.3 Firebase Composite Index
```
Collection: subscriptions
Fields:
  - status (Ascending)
  - nextBillingDate (Ascending)
  - __name__ (Ascending)
```

### 8.4 ì‘ë‹µ í˜•ì‹
```json
{
  "success": true,
  "trialConverted": 2,
  "trialExpired": 1,
  "cardExpiringAlerts": 0,
  "pendingPlansApplied": 1,
  "gracePeriodExpired": 0,
  "paymentsProcessed": 5,
  "details": {
    "convertedTrials": [...],
    "expiredTrials": [...],
    "cardExpiringAlerts": [...],
    "appliedPendingPlans": [...],
    "expiredGracePeriods": [...],
    "billingResults": [...]
  }
}
```

### 8.5 ëª¨ë‹ˆí„°ë§
- **Vercel ë¡œê·¸**: Deployments â†’ Functions â†’ Cron
- **ìˆ˜ë™ ì‹¤í–‰**: `curl -X GET -H "Authorization: Bearer $CRON_SECRET" https://your-domain.com/api/cron/billing`
- **N8N ì›¹í›…**: ê° ì´ë²¤íŠ¸ë³„ ì•Œë¦¼ ìˆ˜ì‹ 

---

## 9. Firestore ì»¬ë ‰ì…˜ êµ¬ì¡°

### 9.1 ì£¼ìš” ì»¬ë ‰ì…˜

| ì»¬ë ‰ì…˜ | ìš©ë„ | ì‚­ì œ ì‹œ ì²˜ë¦¬ |
|--------|------|-------------|
| `tenants` | ë§¤ì¥ ì •ë³´ | Soft delete (`deleted: true`) |
| `subscriptions` | êµ¬ë… ì •ë³´ | Soft delete |
| `users` | íšŒì› ì •ë³´ | Soft delete + ë²•ë ¹ ë³´ê´€ |
| `cards` | ì¹´ë“œ ì •ë³´ | **ì™„ì „ ì‚­ì œ** |
| `payments` | ê²°ì œ ì´ë ¥ | ì‚­ì œ ì•ˆí•¨ (ë²•ë ¹ ë³´ê´€) |
| `refunds` | í™˜ë¶ˆ ì´ë ¥ | ì‚­ì œ ì•ˆí•¨ |

### 9.2 ë¡œê·¸ ì»¬ë ‰ì…˜

| ì»¬ë ‰ì…˜ | ìš©ë„ |
|--------|------|
| `tenant_deletions` | ë§¤ì¥ ì‚­ì œ ë¡œê·¸ |
| `account_deletions` | íšŒì› íƒˆí‡´ ë¡œê·¸ |
| `payment_notifications` | ì•Œë¦¼ ì´ë ¥ (TODO) |

### 9.3 subscriptions ì»¬ë ‰ì…˜ í•„ë“œ

```typescript
{
  // ê¸°ë³¸ ì •ë³´
  tenantId: string,
  email: string,
  brandName: string,

  // í”Œëœ ì •ë³´
  plan: 'trial' | 'basic' | 'business',
  amount: number,
  pricePolicy?: 'grandfathered' | 'protected_until' | 'standard',
  priceProtectedUntil?: Date,

  // êµ¬ë… ìƒíƒœ
  status: 'trial' | 'active' | 'canceled' | 'past_due' | 'suspended' | 'expired',

  // ê¸°ê°„ ì •ë³´
  currentPeriodStart: Date,
  currentPeriodEnd: Date,
  nextBillingDate: Date,
  trialEndDate?: Date,

  // í•´ì§€ ì •ë³´
  canceledAt?: Date,
  cancelReason?: string,
  cancelMode?: 'immediate' | 'scheduled',
  expiredAt?: Date,
  reactivatedAt?: Date,

  // í”Œëœ ë³€ê²½ ì˜ˆì•½
  pendingPlan?: string,
  pendingAmount?: number,
  pendingMode?: 'immediate' | 'scheduled',
  pendingChangeAt?: Date,
  previousPlan?: string,
  previousAmount?: number,

  // ê²°ì œ ì •ë³´
  billingKey?: string,
  cardInfo?: object,

  // ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬
  retryCount?: number,
  gracePeriodUntil?: Date,
  lastPaymentError?: string,
  suspendedAt?: Date,

  // í™˜ë¶ˆ ì •ë³´
  refundAmount?: number,
  refundProcessed?: boolean,

  // ì‚­ì œ ì •ë³´
  deleted?: boolean,
  deletedAt?: Date,

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt: Date,
  updatedAt: Date
}
```

---

## 10. ì•Œë¦¼ ì´ë ¥ ê´€ë¦¬ ì‹œìŠ¤í…œ (TODO)

### 10.1 payment_notifications ì»¬ë ‰ì…˜ êµ¬ì¡°

```typescript
{
  id: string;                    // ìë™ ìƒì„±
  tenantId: string;              // í…Œë„ŒíŠ¸ ID
  email: string;                 // ì‚¬ìš©ì ì´ë©”ì¼
  event: NotificationEvent;      // ì´ë²¤íŠ¸ íƒ€ì…
  status: 'pending' | 'sent' | 'failed';
  metadata: object;              // ì´ë²¤íŠ¸ë³„ ì¶”ê°€ ë°ì´í„°
  sentAt?: Timestamp;            // ë°œì†¡ ì™„ë£Œ ì‹œê°„
  failedAt?: Timestamp;          // ë°œì†¡ ì‹¤íŒ¨ ì‹œê°„
  errorMessage?: string;         // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€
  createdAt: Timestamp;          // ìƒì„± ì‹œê°„
}

type NotificationEvent =
  | 'trial_expired'              // ë¬´ë£Œì²´í—˜ ë§Œë£Œ
  | 'card_expiring_soon'         // ì¹´ë“œ ë§Œë£Œ ì„ë°•
  | 'payment_retry_1'            // ê²°ì œ ì¬ì‹œë„ 1íšŒì°¨
  | 'payment_retry_2'            // ê²°ì œ ì¬ì‹œë„ 2íšŒì°¨
  | 'payment_failed_grace_period' // 3íšŒ ì‹¤íŒ¨ í›„ ìœ ì˜ˆ ê¸°ê°„ ì‹œì‘
  | 'grace_period_expired'       // ìœ ì˜ˆ ê¸°ê°„ ë§Œë£Œ
  | 'card_update_retry_success'  // ì¹´ë“œ ë³€ê²½ í›„ ìë™ ì¬ê²°ì œ ì„±ê³µ
  | 'recurring_payment_success'  // ì •ê¸°ê²°ì œ ì„±ê³µ
  | 'pending_plan_applied';      // ì˜ˆì•½ í”Œëœ ì ìš©
```

### 10.2 êµ¬í˜„ ê³„íš

#### 1ë‹¨ê³„: í—¬í¼ í•¨ìˆ˜ ìƒì„±
```typescript
// lib/notification.ts
export async function saveNotification(params: {
  tenantId: string;
  email: string;
  event: NotificationEvent;
  metadata: object;
}): Promise<string> {
  // ì¤‘ë³µ ì²´í¬ (ê°™ì€ ì´ë²¤íŠ¸ê°€ 24ì‹œê°„ ë‚´ ë°œì†¡ë˜ì—ˆëŠ”ì§€)
  // Firestoreì— ì €ì¥
  // ë¬¸ì„œ ID ë°˜í™˜
}

export async function updateNotificationStatus(
  notificationId: string,
  status: 'sent' | 'failed',
  errorMessage?: string
): Promise<void> {
  // ë°œì†¡ ê²°ê³¼ ì—…ë°ì´íŠ¸
}
```

#### 2ë‹¨ê³„: Cron Job ìˆ˜ì •
- N8N ì›¹í›… ì „ì†¡ ì „ì— `saveNotification()` í˜¸ì¶œ
- ì›¹í›… ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ `updateNotificationStatus()` í˜¸ì¶œ
- ì¤‘ë³µ ì²´í¬ë¡œ 24ì‹œê°„ ë‚´ ë™ì¼ ì•Œë¦¼ ë°©ì§€

#### 3ë‹¨ê³„: ì¤‘ë³µ ë°©ì§€ ë¡œì§
```typescript
// ì¹´ë“œ ë§Œë£Œ ì•Œë¦¼ ì˜ˆì‹œ
const recentNotification = await db
  .collection('payment_notifications')
  .where('tenantId', '==', tenantId)
  .where('event', '==', 'card_expiring_soon')
  .where('createdAt', '>=', last24Hours)
  .limit(1)
  .get();

if (!recentNotification.empty) {
  // ì´ë¯¸ ë°œì†¡í–ˆìœ¼ë¯€ë¡œ ìŠ¤í‚µ
  return;
}
```

### 10.3 í˜œíƒ

1. **ì•Œë¦¼ ì¶”ì **: ì–´ë–¤ ì‚¬ìš©ìì—ê²Œ ì–¸ì œ ì–´ë–¤ ì•Œë¦¼ì„ ë³´ëƒˆëŠ”ì§€ ê¸°ë¡
2. **ì¤‘ë³µ ë°©ì§€**: ì¹´ë“œ ë§Œë£Œ ì•Œë¦¼ ë“± ë§¤ì¼ ì¤‘ë³µ ë°œì†¡ ë°©ì§€
3. **ì‹¤íŒ¨ ì¬ì‹œë„**: ì‹¤íŒ¨í•œ ì•Œë¦¼ ì¬ë°œì†¡ ê°€ëŠ¥
4. **í†µê³„ ë¶„ì„**: ì•Œë¦¼ ë°œì†¡ë¥ , ì„±ê³µë¥  ë“± ë¶„ì„ ê°€ëŠ¥
5. **ê³ ê° ì§€ì›**: ê³ ê° ë¬¸ì˜ ì‹œ ì•Œë¦¼ ì´ë ¥ í™•ì¸ ê°€ëŠ¥

### 10.4 Firebase Composite Index

```
Collection: payment_notifications
Fields:
  - tenantId (Ascending)
  - event (Ascending)
  - createdAt (Descending)
```

---

## 11. ì°¸ê³  ìë£Œ

### ê¸€ë¡œë²Œ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
- [Stripe: Prorations Documentation](https://docs.stripe.com/billing/subscriptions/prorations) - í”Œëœ ë³€ê²½ ì‹œ ì¼í•  ê³„ì‚° ê°€ì´ë“œ
- [Paddle: Proration & Prorated Billing](https://www.paddle.com/resources/proration) - í”„ë¡œë ˆì´ì…˜ ê°œë… ì„¤ëª…
- [Chargebee: Billing Mode & Proration](https://www.chargebee.com/docs/billing/2.0/subscriptions/proration) - ë‹¤ì–‘í•œ í”„ë¡œë ˆì´ì…˜ ëª¨ë“œ
- [RevenueCat: Google Play Subscription Lifecycle](https://www.revenuecat.com/blog/engineering/google-play-lifecycle/) - êµ¬ë… ìƒëª…ì£¼ê¸° ê´€ë¦¬
- [Recurly: Subscription Management Best Practices](https://recurly.com/blog/five-subscription-management-best-practices-for-every-type-of-business-model/) - êµ¬ë… ê´€ë¦¬ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### í•œêµ­ ê²°ì œ ì‹œìŠ¤í…œ
- [í† ìŠ¤í˜ì´ë¨¼ì¸ : êµ¬ë… ê²°ì œ ì„œë¹„ìŠ¤ êµ¬í˜„í•˜ê¸° (ë¹Œë§í‚¤)](https://www.tosspayments.com/blog/articles/22425)
- [í† ìŠ¤í˜ì´ë¨¼ì¸ : êµ¬ë… ê²°ì œ ì„œë¹„ìŠ¤ êµ¬í˜„í•˜ê¸° (ìŠ¤ì¼€ì¤„ë§)](https://docs.tosspayments.com/blog/subscription-service-2)

### ì—£ì§€ ì¼€ì´ìŠ¤ & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
- [Subscription Billing Cycle Best Practices](https://www.subscriptionflow.com/2025/05/optimizing-your-subscription-billing-cycle/)
- [Kinde: Proration Explained](https://kinde.com/learn/billing/plans/proration-explained-how-to-handle-subscription-upgrades-and-downgrades-fairly-and-efficiently/)

---

## 12. ë‹¤ìŒ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1: ì•ˆì •ì„± (Critical)
1. ~~**ì¤‘ë³µ ê²°ì œ ë°©ì§€** (ë©±ë“±ì„± í‚¤)~~ âœ… ì™„ë£Œ
2. **ë™ì‹œì„± ì œì–´ ê°•í™”** (Optimistic Locking)
3. ~~**í™˜ë¶ˆ ê¸ˆì•¡ ê³„ì‚° ì˜¤ë¥˜ ë°©ì§€** (0ìœ¼ë¡œ ë‚˜ëˆ„ê¸°, ìŒìˆ˜ ë°©ì§€)~~ âœ… ì™„ë£Œ

### Phase 2: ì‚¬ìš©ì ê²½í—˜ (High Priority)
4. **ì•Œë¦¼ ì´ë ¥ ê´€ë¦¬ ì‹œìŠ¤í…œ** (`payment_notifications` ì»¬ë ‰ì…˜)
   - N8N ì›¹í›… ì „ì†¡ ì‹œ Firestoreì— ì €ì¥
   - ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ (ì¹´ë“œ ë§Œë£Œ ì•Œë¦¼ ë§¤ì¼ ë°œì†¡ ë°©ì§€)
   - ì•Œë¦¼ ë°œì†¡ ì´ë ¥ ì¡°íšŒ ë° í†µê³„
   - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜
5. **ë°ì´í„° ìë™ ì‚­ì œ ìŠ¤ì¼€ì¤„ëŸ¬** - 90ì¼ í›„ ìë™ ì‚­ì œ

### Phase 3: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Medium Priority) (ì„ íƒì‚¬í•­)
6. **ì¿ í°/í”„ë¡œëª¨ì…˜ ì½”ë“œ**
7. **ì—°ê°„ êµ¬ë…**
8. **ê²°ì œ ì£¼ê¸° ë§ˆì§€ë§‰ ë‚  í”Œëœ ë³€ê²½ ì œí•œ**

### Phase 4: ê¸€ë¡œë²Œ í™•ì¥ (Low Priority) (ì„ íƒì‚¬í•­)
9. **ì„¸ê¸ˆ/VAT ì²˜ë¦¬**
10. **ë‹¤ì¤‘ í†µí™” ì§€ì›**

## ê¸°íƒ€ - ë„ë©”ì¸ ì´ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í˜„ì¬ ìƒíƒœ
- ë„ë©”ì¸: yamoo.ai.kr (ê°€ë¹„ì•„ì—ì„œ ê´€ë¦¬)
- í˜„ì¬ ë„¤ì„ì„œë²„: ì•„ì„ì›¹ (ns1.imweb.me, ns2.imweb.me)
- ê°€ë¹„ì•„ DNSì— Vercel ë ˆì½”ë“œ ì¶”ê°€ ì™„ë£Œ

### ë‚¨ì€ ì‘ì—…

```
1. ë„¤ì„ì„œë²„ ë³€ê²½
   â”œâ”€ ê°€ë¹„ì•„ ë„ë©”ì¸ ê´€ë¦¬ â†’ ë„¤ì„ì„œë²„ ì„¤ì •
   â””â”€ ì•„ì„ì›¹ ë„¤ì„ì„œë²„ â†’ ê°€ë¹„ì•„ ìì²´ ë„¤ì„ì„œë²„ë¡œ ë³€ê²½
       (ns.gabia.co.kr, ns1.gabia.co.kr)

2. Vercel ë„ë©”ì¸ ì¶”ê°€
   â”œâ”€ Vercel í”„ë¡œì íŠ¸ â†’ Settings â†’ Domains
   â”œâ”€ yamoo.ai.kr ì¶”ê°€
   â””â”€ í•„ìš”í•œ ì„œë¸Œë„ë©”ì¸ ì¶”ê°€ (pay.yamoo.ai.kr ë“±)

3. DNS ì „íŒŒ ëŒ€ê¸°
   â””â”€ ìµœëŒ€ 48ì‹œê°„ (ë³´í†µ ëª‡ ì‹œê°„ ë‚´ ì™„ë£Œ)

4. í™•ì¸ ì‘ì—…
   â”œâ”€ yamoo.ai.kr ì ‘ì† í…ŒìŠ¤íŠ¸
   â”œâ”€ SSL ì¸ì¦ì„œ ìë™ ë°œê¸‰ í™•ì¸ (Vercelì—ì„œ ìë™ ì²˜ë¦¬)
   â””â”€ ê¸°ì¡´ ì„œë¸Œë„ë©”ì¸ ì •ìƒ ì‘ë™ í™•ì¸

5. ì•„ì„ì›¹ ì„œë¹„ìŠ¤ í•´ì§€
   â””â”€ ëª¨ë“  í™•ì¸ ì™„ë£Œ í›„ ì§„í–‰
```

### ì£¼ì˜ì‚¬í•­
- SSL ì¸ì¦ì„œëŠ” Vercelì—ì„œ ìë™ ë°œê¸‰ (ì•„ì„ì›¹ì—ì„œ ì´ì „ ë¶ˆí•„ìš”)
- ë„¤ì„ì„œë²„ ë³€ê²½ ì‹œ ê¸°ì¡´ ì•„ì„ì›¹ ì„œë¹„ìŠ¤ ì¦‰ì‹œ ì¤‘ë‹¨ë¨
- DNS ì „íŒŒ ì‹œê°„ ë™ì•ˆ ì¼ì‹œì ìœ¼ë¡œ ì ‘ì† ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŒ