# 계정/매장 관리 시스템 개편 계획

> 작성일: 2025-12-28
> 수정일: 2025-12-29

---

## 1. 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│  yamoo-payment (메인 홈페이지)                               │
│                                                             │
│  ├─ 랜딩 페이지 (/about)                                     │
│  ├─ 요금제 (/pricing)                                        │
│  ├─ 회원가입/로그인 (/login)                                  │
│  │   ├─ 이메일 + 비밀번호 + SMS 인증                         │
│  │   ├─ Google 소셜 로그인 + SMS 인증                        │
│  │   └─ 카카오 소셜 로그인 + SMS 인증 (고려중)                │
│  ├─ 무료체험 신청 (로그인 필수) → 매장 생성                   │
│  ├─ 마이페이지 (/account)                                    │
│  │   ├─ 계정 정보 관리                                      │
│  │   ├─ 매장 목록 / 수정, 추가, 삭제                          │
│  │   └─ 구독 / 결제 관리                                     │
│  └─ 결제 (/checkout)                                         │
│                                                             │
│  🔗 Firebase (계정 + 매장 + 구독)                            │
│  🔗 Airtable (동기화)                                        │
│  🔗 Postmark (이메일)                                        │
│  🔗 Sentry (에러 모니터링)                                   │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ SSO (세션/토큰 공유)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  포탈 (서비스 사용)                                          │
│                                                             │
│  ├─ 로그인 (홈페이지와 동일한 계정)                           │
│  │   ├─ SSO (홈페이지에서 넘어온 경우 → 자동 로그인)          │
│  │   └─ 직접 접근 시 → 동일한 ID/PW로 로그인                  │
│  ├─ 매장 상세 설정 (FAQ, 데이터 등)                          │
│  ├─ 대화 관리                                                │
│  └─ 서비스 사용                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 비회원의 여정

```
1️⃣ 홈페이지 방문 (yamoo.ai.kr)
   ├─ 서비스 소개 확인
   ├─ 요금제 확인
   └─ "무료체험 시작하기" 또는 "구독하기" 클릭
                    ↓
         ⚠️ "로그인이 필요합니다" → 로그인 페이지로 이동
                    ↓
2️⃣ 회원가입 (/login)
   ┌─────────────────────────────────────┐
   │  이름: [홍길동]                       │
   │  연락처: [010-1234-5678] [인증요청]   │
   │          → SMS 인증코드 입력          │
   │  이메일: [hong@email.com]            │
   │  비밀번호: [********]                │
   │  [가입하기]                          │
   │                                     │
   │  ─── 또는 소셜 로그인 ───             │
   │  [Google] [카카오]                   │
   │  → 소셜 로그인 후 연락처 SMS 인증     │
   └─────────────────────────────────────┘
                    ↓
3️⃣ 매장 등록 (무료체험 신청)
   ┌─────────────────────────────────────┐
   │  이름: 홍길동 (자동)                  │
   │  연락처: 010-1234-5678 (자동)        │
   │  이메일: hong@email.com (자동)       │
   │  매장명: [야무 스터디카페 강남점]      │
   │  업종: [스터디카페/독서실 ▼] (기본값)  │
   │  [무료체험 시작하기]                  │
   └─────────────────────────────────────┘
                    ↓
4️⃣ 무료체험 시작 (1개월)
   "1개월 무료체험이 시작되었습니다!"
   [포탈로 이동하기] → SSO 자동 로그인
                    ↓
5️⃣ 포탈에서 서비스 이용
   ├─ FAQ 설정
   ├─ 데이터 관리
   └─ 대화 관리
                    ↓
6️⃣ 결제 (체험 중 또는 체험 종료 후)
   홈페이지 → 로그인 상태 → /checkout
   └─ 토스 결제 (카드 본인확인)
                    ↓
7️⃣ 유료 구독
   └─ 계속 서비스 이용
```

---

## 3. 기능별 담당

| 기능 | yamoo-payment | 포탈 |
|------|--------------|------|
| 회원가입/로그인 | ✅ | 동일 계정 사용 |
| 연락처 인증 | ✅ (SMS) | - |
| 계정 정보 관리 | ✅ | - |
| 매장 생성 (기본 정보) | ✅ | - |
| 매장 상세 설정 (FAQ 등) | - | ✅ |
| 구독/결제 관리 | ✅ | - |
| 서비스 사용 | - | ✅ |

---

## 4. 인증 체계

### 4-1. 회원가입 (yamoo-payment)

```
┌─────────────────────────────────────────┐
│  회원가입                                │
│                                         │
│  이름: [              ]                 │
│  연락처: [            ] [인증요청]       │
│          → SMS 인증코드 입력             │
│  이메일: [              ]               │
│  비밀번호: [            ]               │
│  [가입하기]                              │
│                                         │
│  ──── 또는 소셜 로그인 ────              │
│  [Google로 계속하기]                     │
│  [카카오로 계속하기] (고려중)             │
│  → 소셜 로그인 후 연락처 추가 입력        │
└─────────────────────────────────────────┘
```

### 4-2. 로그인

```
┌─────────────────────────────────────────┐
│  로그인                                  │
│                                         │
│  [Google로 계속하기]                     │
│  [카카오로 계속하기]                     │
│                                         │
│  ──── 또는 ────                         │
│                                         │
│  이메일: [                  ]           │
│  비밀번호: [                ]           │
│  [로그인]                               │
│                                         │
│  계정이 없으신가요? 회원가입             │
└─────────────────────────────────────────┘
```

### 4-3. 포탈 로그인

```
방법 1: 홈페이지에서 "포탈로 이동"
└─ SSO → 자동 로그인 (추가 인증 불필요)

방법 2: 직접 포탈 URL 접근 (app.yamoo.ai.kr)
└─ 홈페이지와 동일한 ID/PW 또는 소셜 로그인
```

### 인증 방식 정리

| 상황 | 인증 방식 |
|------|----------|
| 회원가입 | SMS 인증 (연락처 확인) |
| 소셜 로그인 후 | 연락처 추가 입력 + SMS 인증 |
| 결제 | 카드 본인확인 (토스 자동 처리) |

※ KG 본인인증 불필요 - SMS 인증 + 카드 결제로 충분

---

## 5. 무료체험

| 항목 | 내용 |
|------|------|
| 기간 | 1개월 |
| 조건 | 회원가입 필수 (연락처 1개 = 계정 1개) |
| 기본 업종 | 스터디카페 / 독서실 |
| 매장 수 | 1개 (추가 매장은 마이페이지에서) |

### 왜 회원가입 후 무료체험인가?

| 문제 | 해결 |
|------|------|
| 1인 다계정 어뷰징 | SMS 인증으로 연락처당 1계정 |
| 계정-데이터 연동 | 처음부터 연결되어 깔끔 |
| 포탈 로그인 | 동일 계정 사용 (별도 인증 불필요) |
| 결제 연결 | 이미 로그인된 계정으로 바로 진행 |

---

## 6. 에러 모니터링 (Sentry)

```
Sentry 연동:
├─ 에러 자동 캡처
├─ 슬랙 알림 연동
├─ 컨텍스트 (email, brandName 등)
└─ 이슈 관리
```

### 설정 방법
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

---

## 7. 필요한 개발 작업

### yamoo-payment

| 작업 | 설명 |
|------|------|
| SMS 인증 연동 | 회원가입 시 연락처 인증 (알림톡 또는 SMS) |
| 카카오 로그인 추가 | Firebase Auth 카카오 연동 (고려중) |
| 소셜 로그인 후 연락처 수집 | 추가 정보 입력 UI |
| 매장 생성 API | POST /api/tenants |
| 매장 추가 UI | 마이페이지에 [+ 매장 추가] |
| 무료체험 플로우 | 로그인 → 매장등록 → 체험시작 |
| Airtable 연동 | lib/airtable.ts |
| Sentry 설정 | @sentry/nextjs 설치 + 설정 |
| 포탈 SSO | 토큰/세션 공유 |

### 포탈

| 작업 | 설명 |
|------|------|
| Firebase Auth 연동 | 홈페이지와 동일한 인증 사용 |
| SSO 수신 처리 | 홈페이지에서 전달받은 토큰 처리 |
| 기존 이메일 보안코드 제거 | ID/PW 로그인으로 교체 |

---

## 8. 데이터 흐름

```
┌─────────────────┐
│  yamoo-payment  │
│  (계정+매장 생성) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│    Firebase     │────▶│     Airtable    │
│  (Auth + Firestore)   │  (branchNo 등)  │
└────────┬────────┘     └─────────────────┘
         │
         ▼
┌─────────────────┐
│      포탈       │
│  (같은 Firebase  │
│   데이터 사용)   │
└─────────────────┘
```

---

## 9. 개발 우선순위

### Phase 1: 기본 구조
- [ ] Sentry 설정
- [ ] SMS 인증 연동
- [ ] 회원가입 플로우 수정
- [ ] 소셜 로그인 후 연락처 수집 UI

### Phase 2: 무료체험 + 매장
- [ ] 무료체험 플로우 (로그인 필수)
- [ ] 매장 생성 API (`/api/tenants`)
- [ ] 매장 등록 UI
- [ ] Airtable 연동

### Phase 3: 포탈 연동
- [ ] 포탈 Firebase Auth 연동
- [ ] SSO 구현
- [ ] 기존 이메일 보안코드 제거
- [ ] 카카오 로그인 추가 (고려중)

### Phase 4: 도메인 이전
- [ ] 가비아 네임서버 변경 (아임웹 → 가비아 자체)
- [ ] Vercel에 도메인 추가 (yamoo.ai.kr)
- [ ] SSL 인증서 자동 발급 확인
- [ ] 서브도메인 설정 (app, pay 등)
- [ ] 테스트 및 확인
- [ ] 아임웹 서비스 해지

---

## 10. 파일 구조 (예상)

```
yamoo-payment/
├── app/
│   ├── api/
│   │   ├── auth/
│   │   │   └── sms-verify/
│   │   │       └── route.ts    # SMS 인증
│   │   └── tenants/
│   │       └── route.ts        # 매장 생성 API
│   ├── login/
│   │   └── page.tsx            # 회원가입/로그인 (SMS 인증 포함)
│   └── account/
│       └── page.tsx            # 마이페이지 (매장 추가 UI)
├── lib/
│   ├── airtable.ts             # Airtable API 헬퍼
│   ├── ulid.ts                 # ULID 생성
│   └── sms.ts                  # SMS 발송 (알림톡 또는 SMS)
└── sentry.*.config.ts          # Sentry 설정
```

---

## 11. 도메인 이전 체크리스트

### 현재 상태
- 도메인: yamoo.ai.kr (가비아에서 관리)
- 현재 네임서버: 아임웹 (ns1.imweb.me, ns2.imweb.me)
- 가비아 DNS에 Vercel 레코드 추가 완료

### 남은 작업

```
1. 네임서버 변경
   ├─ 가비아 도메인 관리 → 네임서버 설정
   └─ 아임웹 네임서버 → 가비아 자체 네임서버로 변경
       (ns.gabia.co.kr, ns1.gabia.co.kr)

2. Vercel 도메인 추가
   ├─ Vercel 프로젝트 → Settings → Domains
   ├─ yamoo.ai.kr 추가
   └─ 필요한 서브도메인 추가 (pay.yamoo.ai.kr 등)

3. DNS 전파 대기
   └─ 최대 48시간 (보통 몇 시간 내 완료)

4. 확인 작업
   ├─ yamoo.ai.kr 접속 테스트
   ├─ SSL 인증서 자동 발급 확인 (Vercel에서 자동 처리)
   └─ 기존 서브도메인 정상 작동 확인

5. 아임웹 서비스 해지
   └─ 모든 확인 완료 후 진행
```

### 주의사항
- SSL 인증서는 Vercel에서 자동 발급 (아임웹에서 이전 불필요)
- 네임서버 변경 시 기존 아임웹 서비스 즉시 중단됨
- DNS 전파 시간 동안 일시적으로 접속 불안정할 수 있음

---

## 12. 참고

### 기존 N8N 워크플로우 (trial-start)
- 위치: `🐥 trial-start.json` (C:\Users\catki\Downloads)
- 기능: 웹훅 → ID 생성 → Airtable → 매직링크 → 이메일
- ※ 새 플로우에서는 사용 안함 (자체 처리)

### 관련 문서
- [TECH_STACK.md](docs/TECH_STACK.md)
