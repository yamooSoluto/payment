# 계정/매장 관리 시스템 개편 계획

> 작성일: 2025-12-28

---

## 1. 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│  yamoo-payment (메인)                                        │
│                                                             │
│  ├─ 랜딩 페이지 (/about)                                     │
│  ├─ 요금제 (/pricing)                                        │
│  ├─ 회원가입/로그인 (/login)                                  │
│  │   ├─ 이메일 + 비밀번호                                    │
│  │   ├─ Google 소셜 로그인                                   │
│  │   ├─ 카카오 (고려중)                                       │
│  │   └─ KG모빌리언스 휴대폰 본인인증                          │
│  ├─ 무료체험 신청 → 계정 + 매장 생성                          │
│  ├─ 마이페이지 (/account)                                    │
│  │   ├─ 계정 정보 관리                                      │
│  │   ├─ 매장 목록 / 수정, 추가, 삭제                          │
│  │   └─ 구독 / 결제 관리                                     │
│  └─ 결제 (/checkout)                                         │
│                                                             │
│  🔗 Firebase (계정 + 매장 + 구독)                            │
│  🔗 Airtable (동기화)                                        │
│  🔗 Postmark (이메일)                                        │
│  🔗 Sentry (에러 모니터링)                                   │
│  🔗 KG모빌리언스 (휴대폰 본인인증)                            │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ SSO (세션/토큰 공유)
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  포탈 (서비스 사용)                                          │
│                                                             │
│  ├─ 로그인                                                  │
│  │   ├─ SSO (yamoo-payment에서 넘어온 경우 → 추가 인증 불필요/세션 유지) │
│  │   └─ 직접 접근 시 → 카카오 알림톡 번호 인증                │
│  ├─ 매장 상세 설정 (FAQ, 데이터 등)                          │
│  ├─ 대화 관리                                                │
│  └─ 서비스 사용                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 기능별 담당

| 기능 | yamoo-payment | 포탈 |
|------|--------------|------|
| 회원가입/로그인 | ✅ | SSO or 카카오 알림톡 |
| 휴대폰 본인인증 | ✅ (KG모빌리언스) | - |
| 계정 정보 관리 | ✅ | - |
| 매장 생성 (기본 정보) | ✅ | - |
| 매장 상세 설정 (FAQ 등) | - | ✅ |
| 구독/결제 관리 | ✅ | - |
| 서비스 사용 | - | ✅ |

---

## 3. 무료체험 신청 플로우

```
/about 무료체험 폼
├─ 이름
├─ 연락처
├─ 이메일
├─ 상호명
└─ 업종
        ↓
   [신청하기] 클릭
        ↓
   /api/trial/signup 호출
        ↓
┌─────────────────────────────────────────┐
│  1. Firebase Auth 계정 생성             │
│  2. Firestore tenants 문서 생성         │
│  3. Airtable 동기화                     │
│  4. Postmark 이메일 발송                │
│     (비밀번호 설정 링크 or 매직링크)     │
└─────────────────────────────────────────┘
        ↓
   성공 화면 → 이메일 확인 안내 or 바로 로그인
```

### 기존 플로우 (N8N)
```
폼 제출 → N8N 웹훅 → 외부 처리 → 이메일 발송
```

### 변경 후 플로우 (자체 처리)
```
폼 제출 → yamoo-payment API → 직접 처리 → 이메일 발송 (에러 관리는 sentry 통해)
```

---

## 4. 인증 체계

### 4-1. yamoo-payment 로그인/회원가입

```
┌─────────────────────────────────────────┐
│  회원가입                                │
│                                         │
│  1단계: 휴대폰 본인인증 (KG모빌리언스)    │
│  [본인인증하기]                          │
│         ↓                               │
│  2단계: 계정 정보 입력                   │
│  이메일: [                  ]           │
│  비밀번호: [                ]           │
│  [회원가입]                              │
│                                         │
│  ──── 또는 소셜 로그인 ────              │
│  [Google로 계속하기]                     │
│  [카카오로 계속하기]                     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  로그인                                  │
│                                         │
│  [Google로 계속하기]                     │
│  [카카오로 계속하기]                     │
│                                         │
│  ──── 또는 ────                         │
│                                         │
│  이메일: [                  ]           │
│  비밀번호: [                ]           │
│  [로그인]                               │
│                                         │
│  계정이 없으신가요? 회원가입             │
└─────────────────────────────────────────┘
```

### 4-2. 포탈 인증

```
┌─────────────────────────────────────────────────────────────┐
│  케이스 1: yamoo-payment에서 넘어온 경우                      │
│  ─────────────────────────────────────────                   │
│  yamoo-payment 로그인 → [서비스 사용] 클릭                    │
│         ↓                                                   │
│  SSO 토큰과 함께 포탈로 리다이렉트                            │
│         ↓                                                   │
│  추가 인증 없이 바로 서비스 이용                              │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  케이스 2: 직접 포탈 URL로 접근한 경우                        │
│  ─────────────────────────────────────────                   │
│  포탈 URL 직접 접근 (app.yamoo.ai.kr)                        │
│         ↓                                                   │
│  휴대폰 번호 입력                                            │
│         ↓                                                   │
│  카카오 알림톡으로 인증번호 발송                              │
│         ↓                                                   │
│  인증번호 입력 → 로그인 완료                                 │
└─────────────────────────────────────────────────────────────┘
```

### 변경사항
- yamoo-payment: 같은 Firebase Auth 사용 + KG모빌리언스 본인인증
- 포탈: SSO (yamoo-payment에서 온 경우) 또는 카카오 알림톡 인증 (직접 접근 시)
- 카카오 로그인 추가 (고려중)

---

## 5. 에러 모니터링 (Sentry)

```
Sentry 연동:
├─ 에러 자동 캡처
├─ 슬랙 알림 연동
├─ 컨텍스트 (email, brandName 등)
└─ 이슈 관리
```

### 설정 방법
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

### 사용 예시
```typescript
import * as Sentry from '@sentry/nextjs';

Sentry.setContext('trial_signup', {
  email: data.email,
  brandName: data.brandName,
});

try {
  // 로직
} catch (error) {
  Sentry.captureException(error);
  throw error;
}
```

---

## 6. 필요한 개발 작업

### yamoo-payment

| 작업 | 설명 |
|------|------|
| KG모빌리언스 연동 | 회원가입 시 휴대폰 본인인증 |
| 카카오 로그인 추가 | Firebase Auth 카카오 연동 |
| 매장 생성 API | POST /api/tenants |
| 매장 추가 UI | 마이페이지에 [+ 매장 추가] |
| 무료체험 API | /api/trial/signup (계정+매장+Airtable+이메일) |
| 무료체험 폼 수정 | N8N → 자체 API 호출 |
| Airtable 연동 | lib/airtable.ts |
| Sentry 설정 | @sentry/nextjs 설치 + 설정 |
| 포탈 SSO | 토큰/세션 공유 |

### 포탈

| 작업 | 설명 |
|------|------|
| SSO 수신 처리 | yamoo-payment에서 전달받은 토큰 처리 |
| 카카오 알림톡 인증 | 직접 접근 시 번호 인증 |
| 기존 OTP 로직 제거 | 새 인증 방식으로 교체 |

---

## 7. 데이터 흐름

```
┌─────────────────┐
│  yamoo-payment  │
│  (계정+매장 생성) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│    Firebase     │────▶│     Airtable    │
│  (Auth + Firestore)   │  (branchNo 등)  │
└────────┬────────┘     └─────────────────┘
         │
         ▼
┌─────────────────┐
│      포탈       │
│  (같은 Firebase  │
│   데이터 사용)   │
└─────────────────┘
```

---

## 8. 개발 우선순위

### Phase 1: 기본 구조
- [ ] Sentry 설정
- [ ] 무료체험 API (`/api/trial/signup`)
- [ ] Airtable 연동 (`lib/airtable.ts`)
- [ ] 무료체험 폼 수정 (N8N → 자체 API)

### Phase 2: 인증 체계
- [ ] KG모빌리언스 휴대폰 본인인증 연동
- [ ] 카카오 로그인 추가 (고려중)
- [ ] 포탈 SSO 연동
- [ ] 포탈 카카오 알림톡 인증

### Phase 3: 매장 관리
- [ ] 매장 생성 API (`/api/tenants`)
- [ ] 매장 추가 UI
- [ ] 테스트

### Phase 4: 도메인 이전
- [ ] 가비아 네임서버 변경 (아임웹 → 가비아 자체)
- [ ] Vercel에 도메인 추가 (yamoo.ai.kr)
- [ ] SSL 인증서 자동 발급 확인
- [ ] 서브도메인 설정 (app, pay 등)
- [ ] 테스트 및 확인
- [ ] 아임웹 서비스 해지

---

## 9. 파일 구조 (예상)

```
yamoo-payment/
├── app/
│   ├── api/
│   │   ├── trial/
│   │   │   └── signup/
│   │   │       └── route.ts    # 무료체험 신청 API
│   │   ├── tenants/
│   │   │   └── route.ts        # 매장 생성 API
│   │   └── auth/
│   │       └── phone-verify/
│   │           └── route.ts    # KG모빌리언스 본인인증
│   └── account/
│       └── page.tsx            # 마이페이지 (매장 추가 UI)
├── lib/
│   ├── airtable.ts             # Airtable API 헬퍼
│   ├── ulid.ts                 # ULID 생성
│   ├── trial-email.ts          # 이메일 템플릿
│   └── kg-mobilians.ts         # KG모빌리언스 연동
└── sentry.*.config.ts          # Sentry 설정
```

---

## 10. 도메인 이전 체크리스트

### 현재 상태
- 도메인: yamoo.ai.kr (가비아에서 관리)
- 현재 네임서버: 아임웹 (ns1.imweb.me, ns2.imweb.me)
- 가비아 DNS에 Vercel 레코드 추가 완료

### 남은 작업

```
1. 네임서버 변경
   ├─ 가비아 도메인 관리 → 네임서버 설정
   └─ 아임웹 네임서버 → 가비아 자체 네임서버로 변경
       (ns.gabia.co.kr, ns1.gabia.co.kr)

2. Vercel 도메인 추가
   ├─ Vercel 프로젝트 → Settings → Domains
   ├─ yamoo.ai.kr 추가
   └─ 필요한 서브도메인 추가 (pay.yamoo.ai.kr 등)

3. DNS 전파 대기
   └─ 최대 48시간 (보통 몇 시간 내 완료)

4. 확인 작업
   ├─ yamoo.ai.kr 접속 테스트
   ├─ SSL 인증서 자동 발급 확인 (Vercel에서 자동 처리)
   └─ 기존 서브도메인 정상 작동 확인

5. 아임웹 서비스 해지
   └─ 모든 확인 완료 후 진행
```

### 주의사항
- SSL 인증서는 Vercel에서 자동 발급 (아임웹에서 이전 불필요)
- 네임서버 변경 시 기존 아임웹 서비스 즉시 중단됨
- DNS 전파 시간 동안 일시적으로 접속 불안정할 수 있음

---

## 11. 참고

### 기존 N8N 워크플로우 (trial-start)
- 위치: `🐥 trial-start.json`
(C:\Users\catki\Downloads)
- 기능: 웹훅 → ID 생성 → Airtable → 매직링크 → 이메일

### 관련 문서
- [TECH_STACK.md](docs/TECH_STACK.md)
